<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>第四周：Stevedore 的概念、使用与架构</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	text-indent: -1.7em;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
}
.highlight-gray {
	color: rgb(155,154,151);
}
.highlight-brown {
	color: rgb(100,71,58);
}
.highlight-orange {
	color: rgb(217,115,13);
}
.highlight-yellow {
	color: rgb(223,171,1);
}
.highlight-teal {
	color: rgb(15,123,108);
}
.highlight-blue {
	color: rgb(11,110,153);
}
.highlight-purple {
	color: rgb(105,64,165);
}
.highlight-pink {
	color: rgb(173,26,114);
}
.highlight-red {
	color: rgb(224,62,62);
}
.highlight-gray_background {
	background: rgb(235,236,237);
}
.highlight-brown_background {
	background: rgb(233,229,227);
}
.highlight-orange_background {
	background: rgb(250,235,221);
}
.highlight-yellow_background {
	background: rgb(251,243,219);
}
.highlight-teal_background {
	background: rgb(221,237,234);
}
.highlight-blue_background {
	background: rgb(221,235,241);
}
.highlight-purple_background {
	background: rgb(234,228,242);
}
.highlight-pink_background {
	background: rgb(244,223,235);
}
.highlight-red_background {
	background: rgb(251,228,228);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(55, 53, 47, 0.6);
	fill: rgba(55, 53, 47, 0.6);
}
.block-color-brown {
	color: rgb(100,71,58);
	fill: rgb(100,71,58);
}
.block-color-orange {
	color: rgb(217,115,13);
	fill: rgb(217,115,13);
}
.block-color-yellow {
	color: rgb(223,171,1);
	fill: rgb(223,171,1);
}
.block-color-teal {
	color: rgb(15,123,108);
	fill: rgb(15,123,108);
}
.block-color-blue {
	color: rgb(11,110,153);
	fill: rgb(11,110,153);
}
.block-color-purple {
	color: rgb(105,64,165);
	fill: rgb(105,64,165);
}
.block-color-pink {
	color: rgb(173,26,114);
	fill: rgb(173,26,114);
}
.block-color-red {
	color: rgb(224,62,62);
	fill: rgb(224,62,62);
}
.block-color-gray_background {
	background: rgb(235,236,237);
}
.block-color-brown_background {
	background: rgb(233,229,227);
}
.block-color-orange_background {
	background: rgb(250,235,221);
}
.block-color-yellow_background {
	background: rgb(251,243,219);
}
.block-color-teal_background {
	background: rgb(221,237,234);
}
.block-color-blue_background {
	background: rgb(221,235,241);
}
.block-color-purple_background {
	background: rgb(234,228,242);
}
.block-color-pink_background {
	background: rgb(244,223,235);
}
.block-color-red_background {
	background: rgb(251,228,228);
}
.select-value-color-default { background-color: rgba(206,205,202,0.5); }
.select-value-color-gray { background-color: rgba(155,154,151, 0.4); }
.select-value-color-brown { background-color: rgba(140,46,0,0.2); }
.select-value-color-orange { background-color: rgba(245,93,0,0.2); }
.select-value-color-yellow { background-color: rgba(233,168,0,0.2); }
.select-value-color-green { background-color: rgba(0,135,107,0.2); }
.select-value-color-blue { background-color: rgba(0,120,223,0.2); }
.select-value-color-purple { background-color: rgba(103,36,222,0.2); }
.select-value-color-pink { background-color: rgba(221,0,129,0.2); }
.select-value-color-red { background-color: rgba(255,0,26,0.2); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="8fd82c9f-1065-4878-9046-d52e44168409" class="page sans"><header><img class="page-cover-image" src="https://www.notion.so/images/page-cover/woodcuts_1.jpg" style="object-position:center 90%"/><div class="page-header-icon page-header-icon-with-cover"><span class="icon">🚢</span></div><h1 class="page-title">第四周：Stevedore 的概念、使用与架构</h1><table class="properties"><tbody><tr class="property-row property-row-created_time"><th><span class="icon property-icon"><svg viewBox="0 0 14 14" style="width:14px;height:14px;display:block;fill:rgba(55, 53, 47, 0.4);flex-shrink:0;-webkit-backface-visibility:hidden" class="typesCreatedAt"><path d="M6.98643729,14.0000972 C5.19579566,14.0000972 3.40419152,13.3106896 2.04245843,11.9323606 C-0.681017475,9.21200555 -0.680780251,4.76029539 2.04293482,2.04012507 C4.76664406,-0.68004331 9.22427509,-0.68004331 11.9480135,2.04013479 C13.272481,3.36277455 14,5.1330091 14,6.99552762 C14,8.87640182 13.2721894,10.6285043 11.9480135,11.9509302 C10.5679344,13.3105924 8.77756503,14.0000972 6.98643729,14.0000972 Z M10.2705296,7.00913883 L10.2705296,8.46099754 L10.2705296,8.65543362 L10.076181,8.65543362 L8.6543739,8.65543362 L5.72059514,8.65543362 L5.52619796,8.65543362 L5.52619796,8.46099754 L5.52619796,5.52541044 L5.52619796,3.37946773 L5.52619796,3.18502193 L5.72059514,3.18502193 L7.17253164,3.18502193 L7.36692883,3.18502193 L7.36692883,3.37946773 L7.36692883,6.81467358 L10.076181,6.81467358 L10.2705296,6.81467358 L10.2705296,7.00913883 Z M12.1601539,6.99552762 C12.1601539,5.61697497 11.6190112,4.32597154 10.6393933,3.34769528 C8.63253764,1.34336744 5.35197452,1.34061603 3.34153136,3.33944106 C3.33868273,3.34219247 3.33607716,3.34494388 3.33322852,3.34769528 C1.32397148,5.35459953 1.32372842,8.63641682 3.33322852,10.6433794 C5.34295224,12.6504489 8.62968901,12.6504489 10.6393933,10.6433794 C11.6190112,9.66506426 12.1601539,8.37408027 12.1601539,6.99552762 Z"></path></svg></span>Created</th><td><time>@August 16, 2021 4:38 PM</time></td></tr><tr class="property-row property-row-select"><th><span class="icon property-icon"><svg viewBox="0 0 14 14" style="width:14px;height:14px;display:block;fill:rgba(55, 53, 47, 0.4);flex-shrink:0;-webkit-backface-visibility:hidden" class="typesSelect"><path d="M7,13 C10.31348,13 13,10.31371 13,7 C13,3.68629 10.31348,1 7,1 C3.68652,1 1,3.68629 1,7 C1,10.31371 3.68652,13 7,13 Z M3.75098,5.32278 C3.64893,5.19142 3.74268,5 3.90869,5 L10.09131,5 C10.25732,5 10.35107,5.19142 10.24902,5.32278 L7.15771,9.29703 C7.07764,9.39998 6.92236,9.39998 6.84229,9.29703 L3.75098,5.32278 Z"></path></svg></span>Status</th><td><span class="selected-value select-value-color-green">Done</span></td></tr></tbody></table></header><div class="page-body"><p id="c20fc36c-cf74-4a5e-9ddd-c73eb4bb3e88" class="">本文是关于Stevedore 的概念、使用与架构的，
所以一开始针对这个题目以及大牛们留下的问题，我们做了个大胆的尝试。</p><h1 id="4b55ecec-d849-446b-a218-94230c61db6d" class="">一、大胆尝试，冲冲冲</h1><p id="e6c2b598-68f2-40f5-917e-8d5262ea6d00" class="">问题是这样的“我们是否有必要本地化部署一个Stevedore Server？如何部署？”</p><p id="b41a1ede-4217-4ded-998f-8cd597ddc1f5" class="">针对这个问题，小组的大神们做了如下研究。</p><h2 id="af698883-01cd-494e-9b09-610ee8fa94d9" class="">1.1、关键研究点和部署运行</h2><h3 id="7a7112db-6bde-4146-a362-bcad1a1bbafd" class="">部署本地 CDN</h3><ul id="0916558c-aad2-49f3-9a16-cd8a8ee83c51" class="bulleted-list"><li>运行 Stevedore-CDN<pre id="191c8e8c-3dd2-4cac-890e-dece13186c1a" class="code"><code># 启动docker
sudo systemctl start docker
# 启动容器
docker run --rm -v ./cache-server/nginx-persistent.conf:/etc/nginx/nginx.conf:ro -v ~/stevecache:/var/cache/stevedore -p 8080:80 nginx:stable</code></pre></li></ul><ul id="7026f9a0-2f79-4812-90b5-144d11bdb247" class="bulleted-list"><li>查看Stevedore-CDN运行日志<pre id="0bb01fed-17cb-4bf1-be31-b0fa30681175" class="code"><code># 查看容器列表
docker container ls
# 此时能看到容器的 DOCKER_INSTANCE_ID

# Attack到Container
$ docker container attach DOCKER_INSTANCE_ID
# 这里会一直显示日志</code></pre></li></ul><ul id="0d86126c-7b7e-43d6-a97e-5e112e06e176" class="bulleted-list"><li>本地 Stevedore-CDN 验证<p id="8f9d2c02-7a4b-4901-9d00-584b28c2977c" class="">配置 Stevedore Config, 将 public URL 改成 本地 CDN 的 IP 和端口, 并删除 Rollback URL，在 unity 中执行构建命令，可以看到 正常下载 artifacts。</p></li></ul><p id="1485fc03-69bd-4db2-8950-d79a8c0a93c4" class="">
</p><h3 id="1cdd29b3-fd57-4bdb-93ce-2dff132a4d2b" class="">部署本地 Stevedore Server</h3><figure id="5d709c4c-6cba-4646-a8eb-ed59652c8c46" class="image"><a href="index/Untitled.png"><img style="width:1748px" src="index/Untitled.png"/></a></figure><ul id="56b304d4-1e60-4e96-be1f-892855ca0160" class="bulleted-list"><li>Google Cloud Storage<ul id="3221ad0e-7200-4be4-9648-29e905fd371b" class="bulleted-list"><li>访问GCP官网，并登录<figure id="762d53f1-21c4-407b-bc0d-c5071836ade1"><a href="https://console.cloud.google.com/apis/credentials?pli=1&amp;project=unity-ml-bhram-test&amp;folder=&amp;organizationId=" class="bookmark source"><div class="bookmark-info"><div class="bookmark-text"><div class="bookmark-title">Google Cloud Platform</div><div class="bookmark-description">Google Cloud Platform lets you build, deploy, and scale applications, websites, and services on the same infrastructure as Google.</div></div><div class="bookmark-href"><img src="https://accounts.google.com/favicon.ico" class="icon bookmark-icon"/>https://console.cloud.google.com/apis/credentials?pli=1&amp;project=unity-ml-bhram-test&amp;folder=&amp;organizationId=</div></div><img src="https://ssl.gstatic.com/accounts/ui/avatar_2x.png" class="bookmark-image"/></a></figure></li></ul><ul id="9e7a5257-4390-4e7b-80e2-7c03d23c0cc0" class="bulleted-list"><li>生成 API_KEY 和 OAuth<ul id="cbbf08d8-f6df-45d5-99f0-35c804790104" class="bulleted-list"><li>创建证书<figure id="b9d0f349-77eb-4747-8ac1-9966e3990785" class="image"><a href="index/Untitled%201.png"><img style="width:1810px" src="index/Untitled%201.png"/></a></figure></li></ul><ul id="6ff7cb6c-be2a-4714-9a98-fde2b0912ab9" class="bulleted-list"><li>下载 OAuth <figure id="414d698b-2218-4198-9e87-c945de6b3ee6" class="image"><a href="index/Untitled%202.png"><img style="width:2020px" src="index/Untitled%202.png"/></a></figure><p id="0710b2ea-edd1-4e0d-b4a0-47b207d362c1" class="">点击图示右下角 ⬇️ 可下载得到 <em>client_secret.json </em>文件：</p><pre id="fa8f0fd1-c938-4fcb-9c81-975b531674a0" class="code"><code>{
  &quot;web&quot;: {
      &quot;client_id&quot;: &quot;xxxxxxxxxxxxxx.apps.googleusercontent.com&quot;,
      &quot;project_id&quot;: &quot;xxxxxxxxxxxx&quot;,
      &quot;auth_uri&quot;: &quot;https://accounts.google.com/o/oauth2/auth&quot;,
      &quot;token_uri&quot;: &quot;https://oauth2.googleapis.com/token&quot;,
      &quot;auth_provider_x509_cert_url&quot;: &quot;https://www.googleapis.com/oauth2/v1/certs&quot;,
      &quot;client_secret&quot;: &quot;xxxxxxxxxxxxxxxxxxxxxxxxx&quot;,
      &quot;redirect_uris&quot;: [
          &quot;https://xxxxxxxxxxxxxxxxxxxxxxxxxxxx.apps.googleusercontent.com:handleRedirect&quot;
      ]
  }
}</code></pre><p id="e4971104-7c5c-413c-a018-31b26744a31a" class="">将上述 <em>client_secret.json </em>中的信息填入 <code>gcs_credentials</code> （参考下文同名变量）</p></li></ul><ul id="9320e808-8769-44af-9cc1-a7394525977d" class="bulleted-list"><li>创建 Service 账号<p id="0716b535-bb1e-4bb3-91e6-68638c8cd64d" class="">因我们的账号没有权限创建 Google Cloud Project, 因此我们只能在现有的项目下创建一个 Service 账号。</p><figure id="1d1c0c9f-bae0-44e4-99cd-8f088db66244" class="image"><a href="index/Untitled%203.png"><img style="width:2260px" src="index/Untitled%203.png"/></a></figure><p id="5c08bd92-babb-40e2-94c4-59db50095f49" class="">创建完成后，可得到 private_key 以备用。</p></li></ul><ul id="83974680-affc-4938-a9b5-b71e1444c25f" class="bulleted-list"><li>创建 Bucket<p id="bcfd3b35-98a5-424f-8946-bdf8f874b9fe" class="">为避免污染现有服务数据，我们创建了新的 Bucket 以存储 Artifacts.</p><figure id="f1327049-e246-4a3b-95cc-42668e982302" class="image"><a href="index/Untitled%204.png"><img style="width:1622px" src="index/Untitled%204.png"/></a></figure><p id="4e223cd9-c9da-4530-bc56-657422330162" class="">创建完成后，拿到 Bucket 以备用。</p></li></ul></li></ul></li></ul><ul id="a7dc39cd-98d7-4369-a5ee-dc1dc07a0264" class="bulleted-list"><li>启动 Stevedore-infra （Upload Service）<ul id="ddd437d4-6af5-446c-8725-175b84ac89a7" class="bulleted-list"><li>修改 UploadServiceConfig 的 <code>prog</code><p id="5f8417bd-7bf6-4ebf-9f3b-441b314f66c5" class="">文件：<em>services/stevedore/upload/</em><em><strong>main</strong></em><em>.py</em></p><pre id="18a2544c-8cc4-4f7e-b511-f11236a1055a" class="code"><code>class UploadServiceConfig(serviceconfig.BaseServiceConfig):
    prog = &#x27;stevedore.upload.plin_plin_plin_plin_plin_plin_&#x27;</code></pre><p id="0d282a98-5ec2-415e-aab3-e5eb5614e3e5" class="">目的：<code>prog</code> 即 <code>application_secret</code>，有不少于40字符的限制</p></li></ul><ul id="95e79e58-f2ca-408a-9668-fb637e1d022a" class="bulleted-list"><li>配置 Bucket<p id="119b49a1-4673-4a54-a72c-accd6c1c1db4" class="">在 <a href="https://github.cds.internal.unity3d.com/unity/stevedore-infra/blob/8c2efb61f3a156e2f8cceffa4d9ab26897214fdd/services/stevedore/serviceconfig.py">services/stevedore/serviceconfig.py</a> 中，在创建 GoogleCloudStorageStore 时，将上文申请的 bucketID 填入其中。</p></li></ul><ul id="8fa0d7cc-1fed-4873-99eb-493737398ea4" class="bulleted-list"><li>配置 <em>services/config/service.cfg.py</em> 文件<ul id="8c76b108-aca6-4559-8f8a-6b43cdb7a946" class="bulleted-list"><li>根据 <a href="https://github.cds.internal.unity3d.com/unity/stevedore-infra/blob/8c2efb61f3a156e2f8cceffa4d9ab26897214fdd/services/config-templates/service.cfg.py">stevedore-infra/services/config-templates/service.cfg.py </a> 模板生成 <em>service.cfg.py </em>文件，并放置 <em>services/config/ </em>目录下 ( ⚠️: 最新的 master 分支上已经将该模板文件删除，可参考该文件的 <a href="https://github.cds.internal.unity3d.com/unity/stevedore-infra/commits/master/services/config-templates/service.cfg.py">commit history</a> )</li></ul><ul id="d5994159-67aa-44bc-9bc9-4351e4bee475" class="bulleted-list"><li>修改 <code>upload_url_prefix</code> <p id="1ef2acb3-4418-4c7e-bc1c-fb4fd6f9d75f" class=""> 将 &quot;stevedore-upload.ds.unity3d.com&quot; 替换成 &lt;LOCAL_SERVER_IP:PORT&gt;</p></li></ul><ul id="0413269c-4ea5-4dbb-ba40-f2be9d74c31a" class="bulleted-list"><li>修改 <code>gcs_credentials</code><p id="e0f42a4e-a470-45a3-8b5a-e85548289750" class="">将上述 <em>client_secret.json </em>中的信息转换成 Python Dictionary 格式配置至其中，另外private_key参照上述 “生成 Service 账号” 部分所获得的 private_key。</p><pre id="b025c1c2-cc9a-43bb-bf70-9e5b8ee76d50" class="code"><code>gcs_credentials = { 
    &quot;type&quot;: &quot;service_account&quot;,
    &quot;private_key_id&quot;: &quot;xxxx&quot;,
    &quot;private_key&quot;: &quot;xxxx&quot;,
    &quot;client_email&quot;: &quot;xxxx@unity3d.com&quot;,
    &quot;client_id&quot;: &quot;xxxxx&quot;,
    &quot;project_id&quot;: &quot;xxxxx&quot;,
    &quot;auth_uri&quot;: &quot;https://accounts.google.com/o/oauth2/auth&quot;,
    &quot;token_uri&quot;: &quot;https://oauth2.googleapis.com/token&quot;,
    &quot;auth_provider_x509_cert_url&quot;: &quot;https://www.googleapis.com/oauth2/v1/certs&quot;,
    &quot;client_secret&quot;: &quot;X1IDQOvpvuFeubgSTl95iyvb&quot;,
    &quot;redirect_uris&quot;: [
        &quot;https://xxxxxxxx&quot;
    ],
    &quot;client_x509_cert_url&quot;: &quot;{{ cfg_gcs_credentials.client_x509_cert_url }}&quot;
}</code></pre></li></ul></li></ul><ul id="9ebed341-bf20-4ed0-a02d-8765ea0661ec" class="bulleted-list"><li>HMAC<ul id="c77a2528-9e39-4b83-af28-44cac511bd7b" class="bulleted-list"><li>概念： HMAC (Hash-based message authentication code), 散列消息认证码。是使用密码散列函数，同时结合一个加密密钥产生的消息认证码。</li></ul><ul id="3df9d0e3-e061-4aa4-bd3b-4b03f4e297e5" class="bulleted-list"><li>公式：<p id="0d713864-97ea-4892-b480-db4ef6dce66e" class=""><style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi><mi>M</mi><mi>A</mi><mi>C</mi><mo stretchy="false">(</mo><mi>K</mi><mo separator="true">,</mo><mi>m</mi><mo stretchy="false">)</mo><mo>=</mo><mi>H</mi><mo stretchy="false">(</mo><mo stretchy="false">(</mo><msup><mi>K</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>⊕</mo><mi>o</mi><mi>p</mi><mi>a</mi><mi>d</mi><mo stretchy="false">)</mo><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi><mi>H</mi><mo stretchy="false">(</mo><mo stretchy="false">(</mo><msup><mi>K</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>⊕</mo><mi>i</mi><mi>p</mi><mi>a</mi><mi>d</mi><mo stretchy="false">)</mo><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi><mi>m</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">HMAC(K,m)=H((K&#x27;\oplus opad)||H((K&#x27;\oplus ipad)||m))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">m</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.001892em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">((</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⊕</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.001892em;vertical-align:-0.25em;"></span><span class="mord mathnormal">o</span><span class="mord mathnormal">p</span><span class="mord mathnormal">a</span><span class="mord mathnormal">d</span><span class="mclose">)</span><span class="mord">∣∣</span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">((</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⊕</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">i</span><span class="mord mathnormal">p</span><span class="mord mathnormal">a</span><span class="mord mathnormal">d</span><span class="mclose">)</span><span class="mord">∣∣</span><span class="mord mathnormal">m</span><span class="mclose">))</span></span></span></span></span><span>﻿</span></span></p><p id="fb858ff3-4b54-4d37-b38a-6eb044b8586e" class="">其中：<div class="indented"><p id="789f0762-a791-48ca-9b1a-8c8d997041b3" class=""><style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi></mrow><annotation encoding="application/x-tex">H</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span></span></span></span></span><span>﻿</span></span> 为密码<a href="https://zh.wikipedia.org/wiki/%E9%9B%9C%E6%B9%8A%E5%87%BD%E6%95%B8">散列函数</a>（如 <a href="https://zh.wikipedia.org/wiki/SHA%E5%AE%B6%E6%97%8F">SHA 家族</a>）</p><p id="a8a7a21a-3d3e-4cec-a4e0-f080f3f28775" class=""><style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span><span>﻿</span></span> 为<a href="https://zh.wikipedia.org/wiki/%E5%AF%86%E9%92%A5">密钥</a>（secret key）</p><p id="01dae31b-f6ab-4b9c-8a03-8f3afbcdc876" class=""><style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">m</span></span></span></span></span><span>﻿</span></span> 是要认证的消息</p><p id="48c42f5d-cc01-4a98-82a0-9c0875be844d" class=""><style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>K</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">K&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.751892em;vertical-align:0em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span> 是从原始密钥 <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span><span>﻿</span></span> 导出的另一个秘密密钥（如果 <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span><span>﻿</span></span> 短于散列函数的输入块大小，则向右补 <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span></span><span>﻿</span></span>；如果比该块大小更长，则对 <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span><span>﻿</span></span> 进行散列）</p><p id="989c9a5e-8e8a-48a6-bb05-81859f2cd84d" class=""><style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi></mrow><annotation encoding="application/x-tex">|| </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∣∣</span></span></span></span></span><span>﻿</span></span> 代表拼接</p><p id="29d4421d-6773-45b7-81ec-ced9626ca4a2" class=""><style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>⊕</mo></mrow><annotation encoding="application/x-tex">⊕</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord">⊕</span></span></span></span></span><span>﻿</span></span> 代表<a href="https://zh.wikipedia.org/wiki/%E7%95%B0%E6%88%96">异或</a>（XOR）</p><p id="538bae7e-90d9-4788-a4e9-5435b08e53e2" class=""><style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mi>p</mi><mi>a</mi><mi>d</mi><mtext> </mtext></mrow><annotation encoding="application/x-tex">opad </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">o</span><span class="mord mathnormal">p</span><span class="mord mathnormal">a</span><span class="mord mathnormal">d</span><span class="mord"> </span></span></span></span></span><span>﻿</span></span>是外部填充常量（0x5c…5c）</p><p id="c871ae89-a365-4e2d-a96d-e80504f461cb" class=""><style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mi>p</mi><mi>a</mi><mi>d</mi><mtext> </mtext></mrow><annotation encoding="application/x-tex">ipad </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">i</span><span class="mord mathnormal">p</span><span class="mord mathnormal">a</span><span class="mord mathnormal">d</span><span class="mord"> </span></span></span></span></span><span>﻿</span></span>是内部填充常量（0x36…36）</p></div></p></li></ul><ul id="5e65a3fd-cb61-4e2a-b23a-47678d3f81d0" class="bulleted-list"><li>Stevedore中的应用<p id="540667a1-b0a6-4b94-b49d-30bf5f8a394f" class="">Stevedore 使用 hmac 进行消息认证，基于 &quot;RFC 2104 HMAC&quot; 标准的 hmac 算法, <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">blocksize</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">oc</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span></span></span></span></span><span>﻿</span></span> 为 <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>64</mn></mrow><annotation encoding="application/x-tex">64</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">64</span></span></span></span></span><span>﻿</span></span> ，详情可参考 🔗<a href="https://github.cds.internal.unity3d.com/unity/stevedore-infra/blob/acca01159077eadb504a4e1eca421828645f42b1/services/stevedore/hmactoken.py">services/stevedore/hmactoken.py</a> 和 🔗<a href="https://github.com/python/cpython/blob/3.9/Lib/hmac.py">python3/lib/hmac.py</a> 。</p></li></ul></li></ul><ul id="852cadfb-3301-4703-a726-61705a703a8c" class="bulleted-list"><li>构建 stevedore-infra 镜像<pre id="b9968ad3-ecd1-41a4-9e7c-89658043c451" class="code"><code>cd ~/stevedore-infra
make build</code></pre></li></ul><ul id="835ba56a-b750-461b-ae3f-0212fad2c9fa" class="bulleted-list"><li>运行 stevedore-infra 服务<pre id="7a4662db-6b0b-4a62-8b33-3436d5ab9b58" class="code"><code>cd ~/stevedore-infra
make run</code></pre></li></ul></li></ul><ul id="b20d9d0c-da98-4e11-87ea-6a09a5654515" class="bulleted-list"><li>验证：<ul id="cecea7cf-32af-4309-be8f-3e93bf50b665" class="bulleted-list"><li>使用命令行向本地 Stevedore Server 发起 upload 请求<pre id="07f03c48-b8b4-4af9-8cd4-6218816772ce" class="code"><code>curl -H &quot;Authorization: Bearer xxx@unity3d.com:SECRET:&lt;SECRET_KEY&gt;-s&quot; \
--data-binary @&lt;FILENAME&gt; http://&lt;IP&gt;:8000/upload/r/testing/&lt;ARTIFACT-ID&gt;</code></pre><p id="c757dfbc-856b-43e1-bc7d-1e3e6bb14290" class="">注意： Authorization 信息会很快过期，需要重新生成，或者定期从 <a href="https://stevedore.unity3d.com/upload/">https://stevedore.unity3d.com/upload/</a> 页面拷贝替换。</p></li></ul><ul id="e2852f66-af43-45f9-9c05-147c0f394423" class="bulleted-list"><li>请求结果：<figure id="ec3f61e6-001b-42ca-99df-cdf97c8fb008" class="image"><a href="index/Untitled%205.png"><img style="width:3130px" src="index/Untitled%205.png"/></a></figure></li></ul></li></ul><ul id="7614d0ea-36dc-4952-9949-a51790f60587" class="bulleted-list"><li>使用 CCD 作为存储后端<p id="1c59704f-814c-4ff1-bfe1-5139b7eae159" class="">环境因素， Google Cloud 在国内水土不服。针对此问题，我们准备将存储后端迁移至 CCD。</p><ul id="c1902388-580e-4782-bd1c-464d1bfb1362" class="bulleted-list"><li>参照 services/stevedore/stores/dummy.py 模板， 创建 ccd.py, 保障所有接口不变：<pre id="fce12ee9-a3cc-4419-9086-d0c23bbe993d" class="code"><code>class CloudContentDelivery:
	def __init__(self, bucket_name, send_http_request):
	def get_artifact_url(self, artifact_id):
	def list_artifacts(self):
	def upload_artifact(self, artifact_id, upload_body, metadata):</code></pre></li></ul><ul id="837e9577-a0c3-43c5-8dcf-56cbf3c7a97e" class="bulleted-list"><li>接口实现 get_artifact_url<pre id="d5d98c6c-2a64-41cd-8eab-6dfe77ebb661" class="code"><code>dl_url = f&#x27;https://assetstreaming-content.unity.cn/client_api/v1/buckets/{self.bucket_id}/release_by_badge/latest/entry_by_path/content/?path=&#x27;
return f&#x27;{dl_url}{str(artifact_id)}&#x27;</code></pre></li></ul><ul id="8a0c37c8-0614-49fe-ab38-9145df6b7b7f" class="bulleted-list"><li>接口实现 list_artifacts<p id="49e708f1-7153-4c95-9b9d-2a9588dddd92" class="">向 <a href="https://content-api.cloud.unity3d.com/api/v1/buckets/{self.bucket_id}/entries/">https://content-api.cloud.unity3d.com/api/v1/buckets/{self.bucket_id}/entries/</a> 发送Get请求，并处理返回数据即可</p></li></ul><ul id="68cb0083-180b-4b03-96a2-86fa16bfcca6" class="bulleted-list"><li>接口实现 upload_artifact<ul id="6e66621f-a4f4-43d9-96cb-08477db8a0d3" class="bulleted-list"><li>发送 Post 请求，创建 Entry , 拿到 Entry_ID<p id="02b10e65-4c8f-4090-921e-fb880b05809e" class="">API : <a href="https://content-api.cloud.unity3d.com/api/v1/buckets/%7Bself.bucket_id%7D/entries/">https://content-api.cloud.unity3d.com/api/v1/buckets/{self.bucket_id}/entries/</a></p></li></ul><ul id="fba2ab20-d724-4dd1-8ed8-2e5415a24ce4" class="bulleted-list"><li>发送 PATCH 请求，将文件流 Patch 到 Entry_ID 所对应的 blob 对象中。<p id="6d327f63-a399-43a0-be51-ee035d1256a4" class="">API: <a href="https://content-api.cloud.unity3d.com/api/v1/buckets/%7Bself.bucket_id%7D/entries/%7Bentry_id%7D/content/">https://content-api.cloud.unity3d.com/api/v1/buckets/{self.bucket_id}/entries/{entry_id}/content/</a></p></li></ul></li></ul><ul id="10ab3358-00db-428c-8e74-b38baced7f2b" class="bulleted-list"><li>启用 CCD<p id="7720a92d-32c1-4349-b06d-770c45011244" class="">在中，将 <code>gcs.GoogleCloudStorageStore </code>替换成 <code>ccd.CloudContentDelivery</code></p><figure id="ac71fca1-d95b-42c8-b16c-55dc748f25bb" class="image"><a href="index/Untitled%206.png"><img style="width:2752px" src="index/Untitled%206.png"/></a></figure></li></ul><ul id="e4d24746-eeff-4001-843a-9742df18bf8b" class="bulleted-list"><li>验证结果<p id="eb5705f2-cd0d-4fa1-82db-5d6ed43a40ac" class="">运行失败。目前 CCD 上传的逻辑和官网 API 文档不一样，需要重新适配。</p></li></ul></li></ul><p id="c2e5ab70-ca97-43c7-b773-dbe8988e6ab4" class="">
</p><h2 id="a26dc8a0-33d1-4661-8e21-e5b00e6293c2" class="">1.3、本地化意义</h2><p id="a79119b9-bbf9-42cf-9225-3fd591997005" class="">
</p><p id="9737bcb5-e222-41d9-b3f8-c81f9d9e6ebe" class="">本地化的意义无非是更快，更强，更易控制，也就是更快的上传下载速度，更强的使用功能，更容易自己掌控代码。</p><p id="604fa272-71c9-4fbb-bb49-a28f90dddda8" class="">本地化的最终目的就是生产具有中国特色社会主义的产品。</p><h1 id="4e1a6b58-41aa-4f40-89c9-98b1f9385d66" class="">二、疑问</h1><p id="72f5e522-882e-405e-bec9-e4153bcc48fa" class="">针对上面的问题研究，我们大概猜测了Stevedore是干什么的，了解本地化的意义，并且大致知道如何去部署。</p><p id="75802b53-ac6f-4c79-93cc-ceab3e0b10ed" class="">当然大家必然有很多疑问，诸如：什么是Stevedore？Stevedore有什么历史？Stevedore干什么的？在unity中扮演什么角色？具体怎么发布？架构如何？bee如何整合Stevedore代码？</p><p id="e828e7d2-fe7a-479b-963d-13ff5aa5d9ea" class="">带着以上问题，以及初步的了解和大家各自的问题，下面我们进入正题，或许会找到你心中的那个答案。</p><h1 id="2964caa9-7f4f-4472-83a1-562cc4fa72e6" class="">三、Stevedore 与 Unity 的关系</h1><h2 id="a8542e12-3906-4c80-93d6-b45e0e5ae860" class="">1、前世今生</h2><p id="e94a28bd-8c2a-428a-a89a-86e60717eb2b" class="">关于 Stevedore，维基百科上的解释是</p><blockquote id="776cfb3a-216a-42ac-b27c-4a41d0d6a7dd" class="">装卸工或码头工人，码头工人是从事装卸船舶、卡车、火车或飞机的海滨体力劳动者。</blockquote><p id="82e20d05-521d-49c2-bc4f-a42be5ebff69" class="">我们这里提到的 Stevedore 是指内置在 Bee 中，用于替代 Mercurial largefiles 的二进制文件管理器。</p><p id="9e56011b-35fc-4ab4-911d-1a63afd54370" class="">Stevedore 是一个定制的 Unity 工具，用于向开发者（包括 Unity 员工和源代码客户）分发工件（大型二进制文件，例如SDK）。Stevedore 作为构建过程的一部分（对于 Unity 引擎和其他 Unity 项目），通过 HTTP 按需下载必要的工件。</p><h2 id="878ffcb4-ce84-4b39-8a45-0292fc2eaee1" class="">2、为什么选择 Stevedore</h2><p id="943ad7c8-474d-41ba-89f1-3fd6c180c100" class="">在早些时候还没有使用 Stevedore 之前，对于二进制文件的管理，我们使用的是集成在版本控制工具（VCS）的 大文件管理工具（Mercurial largefiles 或相当于 Git 的 Git LFS）。使用它们的好处就是几乎不用额外再集成其他组件，因为它们是内置在版本控制系统（VCS）中的。但通过一段时间的使用，开发团队也发现了一些存在问题，下面就是当时的关于如何选择二进制文件的管理工具，做的一些调研和讨论。</p><p id="1fc033f8-e699-4b26-b899-d4b2098fea79" class="">首先在使用 Mercurial largefiles（或者 Git LFS）（即下文中的 “它”） 中遇到了如下的问题：</p><ul id="66bc3262-63ad-41c1-8e17-cd8bcfb0e80a" class="bulleted-list"><li>它与 VCS 的关联性很大</li></ul><ul id="cb2f8d46-e345-449e-83b1-fd3968270ac3" class="bulleted-list"><li>它和仓库的版本关系密切（个人理解，如果每个版本对应的依赖工件不是同一个版本，那么将会在大文件系统的缓存中存在多个不同版本的大文件，随着版本的增多，这样会让大文件系统的缓存越来越大。）</li></ul><ul id="355a0d1b-5bf8-4bb2-b519-6fd8c18d4b44" class="bulleted-list"><li>它将工件置于与代码相同的审查过程中，使用过程中我们发现这样的审查是不充分的。</li></ul><ul id="a3b4263d-c328-4722-b27c-a77f6fefa8bb" class="bulleted-list"><li>它会把所有存在于仓库中的工件全数下载，其中还包括一些根本无法使用的工件（基于平台相关的工件），这样明显不合理，并且在网速不理想的情况下会让拉取仓库的速度变得很慢。</li></ul><ul id="2a0afd47-37d1-4108-a103-87b6198f5e8f" class="bulleted-list"><li>它导致了很多不必要的工件拷贝</li></ul><ul id="7ea74aa7-0a44-43bf-88d3-effa3caf22ca" class="bulleted-list"><li>现有的解决方案不支持断点续传（对于连接不稳定的用户来说这是个巨大的问题）</li></ul><p id="afa3134b-7d39-42bf-b04e-919cc9333ff7" class="">
因为有上面这些问题，我们决定转向定制的工具，而不是现成的解决方案，因为有一些非标准的要求：支持大型工件（1GB以上），支持更细颗粒度的访问控制（用户在访问级别上更细致的区分），以及自定义授权协议（OAuth）。
一个关键的细节是，Stevedore 客户端将（至少在某些部署中，如主要的 Unity 资源库）与源代码一起被版本化。因此，客户端一旦部署，必须被视为长期有效的版本；而且基础设施必须确保与旧的客户端向后兼容（否则结果将是旧的分支不再构建）。</p><ul id="07f5d309-a143-4958-a2cf-6efe6c43b720" class="bulleted-list"><li>支持大型工件（1GB以上）</li></ul><ul id="cf27ad79-f9e6-4fc7-bc6a-79ae598337a6" class="bulleted-list"><li>支持更细颗粒度的访问控制（用户在访问级别上更细致的区分）</li></ul><ul id="d7cfeed2-a405-40b5-9891-7d8e458f2792" class="bulleted-list"><li>支持自定义授权协议（OAuth）</li></ul><p id="733f89a7-a846-4b06-8379-53b21d1df87f" class="">一个关键的细节是，Stevedore 客户端将（至少在某些部署中，如主要的 Unity 资源库）与源代码一起被版本化。因此，客户端一旦部署，必须被视为长期有效的版本被固定住；而且基础设施必须确保与旧的客户端向后兼容（否则结果将是旧的分支不再构建）。</p><p id="7b6ed5df-f1bb-4665-b613-75ccadaaf7a6" class="">
</p><p id="9f7fd62b-f591-4a83-bfc3-27b296e77293" class="">对于验证 Stevedore 是否是我们满足我们的需求，我们的开发团队做了如下对比，对比图如下：</p><figure id="07abeb58-014c-4bde-a521-89671f1e1d45" class="image"><a href="index/Untitled%207.png"><img style="width:1272px" src="index/Untitled%207.png"/></a></figure><p id="c73f63d7-79b1-4307-a6a7-ec2db40fdd10" class="">我们主要看之前广泛使用的 Hg largefiles 和 现在正在使用的 Stevedore in Bee，我们一项项看：</p><ol type="1" id="161a9363-1c10-4f9a-9443-4852dc5f834f" class="numbered-list" start="1"><li>工具的集成<p id="6f2dff15-ea33-4cfb-92a2-523d44320cd0" class=""><strong>Largefiles：</strong>largefiles 是 Mercurial 的内置功能，我们只要选择了 Mercurial，那使用 largefiles 将不再需要其他额外的依赖。</p><p id="7927ca2d-3732-4239-a633-1e27d8a09172" class=""><strong>Stevedore in Bee：</strong>Stevedore 是 Bee 中的一个工具，并且它还依赖于其他软件，所以使用的话相较于 largefiles 条件要求要高一点。</p></li></ol><ol type="1" id="1cb3599d-8126-4197-9e93-7cd593a33169" class="numbered-list" start="2"><li>工件的获取<p id="c5d9b04c-43d5-4ede-9ba4-6f244ca71c68" class=""><strong>Largefiles：</strong>大文件都是从 repo 的服务器上获取的，对于它们的位置都是相对于 repo 服务器的，只需提供相对位置即可。虽然下载没有什么问题，但它并不能将机密文件和不太机密的文件做一些区分。（如果你知道哈希值并有一个服务器登录的权限，即使你没有访问相关的 repo 的权限，但所有的文件都还是可以使用）</p><p id="c30e8d99-99d6-4b75-80bb-78724fc23bf8" class=""><strong>Stevedore in Bee：</strong>Stevedore 相对来说是分离的，需要配置工件的指定的下载地址。Stevedore 可以在服务端</p></li></ol><ol type="1" id="c5fa83c6-7bec-48d2-bc50-69582854810b" class="numbered-list" start="3"><li>构建系统集成<p id="2e4e3cc2-459f-40d2-911a-9ac0b61bea79" class=""><strong>Largefiles：</strong>Mercurial 确保 build.zips 是可用的，构建系统有一些特定的逻辑来决定哪些需要解压。</p><p id="6e1e8e58-869a-4c0f-9a3b-bb737957b373" class=""><strong>Stevedore in Bee：</strong>在 Stevedore in Bee 的方案中，我们需要与构建系统紧密集成，以避免由于使用链接而导致的不完整或不必要的重建。</p></li></ol><ol type="1" id="4e200022-5584-47e3-ba50-d806510d8eaf" class="numbered-list" start="4"><li>工件的来源<p id="6e43bce2-606e-449b-b5fe-f5d2d73d3bd6" class=""><strong>Largefiles：</strong>Largefiles 依赖于开发者提供他们自己的 build.zip。虽然这些文件应该来自于Katana，并且应该包含源代码的修订信息，但在实践中往往不是这样，开发者会上传各种经过处理的 build.zip 文件。通过维护一个 &quot;Katana祝福&quot;（Katana blessed）的 build.zips 白名单，并在队列验证时对其进行验证来解决。</p><p id="c17d315c-df8d-45be-9691-242b90e602fe" class=""><strong>Stevedore in Bee：</strong>Stevedore 通过只允许 Katana 和选定的用户上传工件来解决工件检查的问题（至少对于主要的存储库）。</p></li></ol><ol type="1" id="eb4b0f62-cca7-4b39-9240-e2bec10ef228" class="numbered-list" start="5"><li>源代码产品审查<p id="66a305c8-fe7d-4a62-b470-406f5e38bf8e" class=""><strong>Largefiles：</strong>因为 build.zips 被嵌入到版本库中，所以我们需要对版本库进行审查，并在与客户共享之前删除机密工件。</p><p id="57af98a6-2e36-4d91-8ddb-3e5fc66e6af0" class=""><strong>Stevedore in Bee</strong>：Stevedore 在很大程度上允许我们按原样分享整个版本库。源代码客户会看到机密工件的存在，但由于 Artifactory 的访问控制，如果它们没有相关权限，他们将无法下载。</p></li></ol><ol type="1" id="5867672f-69e4-47e4-b410-98c3de157dd9" class="numbered-list" start="6"><li>下载时机<p id="f719c390-a873-41f8-85cf-cff860fb8892" class=""><strong>Largefiles：</strong>在拉取代码时一并全部下载。</p><p id="abbcfb52-00da-497f-a3eb-20b05d15a67d" class=""><strong>Stevedore in Bee：</strong>Stevedore 则会在构建时按需下载。</p></li></ol><ol type="1" id="331decdc-4b8b-437a-a3b3-2b568c43e528" class="numbered-list" start="7"><li>下载的文件<p id="b68e0955-55c6-4b5e-b75d-ef56482a52d7" class=""><strong>Largefiles：</strong>每个工件都会被下载，无论用户是否需要它来构建他们想要的东西，以及该工件是否甚至可以在他们当前的操作系统上使用。</p><p id="f4c71985-32ac-4aed-ac4e-e2cd12640e12" class=""><strong>Stevedore in Bee：</strong> Stevedore 的按需下载，将大大减少用户需要下载构建的工件的数量。</p></li></ol><ol type="1" id="70cde9e3-c0a1-4217-815d-3ccbb4aae206" class="numbered-list" start="8"><li>磁盘使用<p id="0c539025-a7d2-405e-94b5-046cd13c160e" class=""><strong>Largefiles：</strong>不必要地工件将被复制到 repo 工作目录中，尽管它们可以直接从大文件缓存中解压。并且大文件缓存必须和 repo 在同一个分区，否则 Mercurial 会创建更多的副本。在最好的情况下（单一的 repo 与大文件缓存在同一分区），工件在磁盘上出现三次。</p><ol type="1" id="89f7faaf-d381-43f4-8ef6-79427ad319da" class="numbered-list" start="1"><li>在缓存中作为一个压缩包</li></ol><ol type="1" id="2b2d627e-95b7-4981-8537-2714e079f730" class="numbered-list" start="2"><li>在工作目录中作为一个压缩包</li></ol><ol type="1" id="ca66286e-4401-46bd-82ec-bfb4519667b8" class="numbered-list" start="3"><li>在工作目录中解压。</li></ol><p id="ab6023b4-fa75-4c08-b108-dd1668e38125" class=""><strong>Stevedore in Bee：</strong>Stevedore 摆脱了上面 Largefiles 存在的问题。</p></li></ol><ol type="1" id="1d6edfa6-3740-4387-a005-6c242759e84c" class="numbered-list" start="9"><li>修改工作流程（本地）<p id="0761a57a-33bc-4592-9155-76ab3ab48a97" class=""><strong>Largefiles：</strong>用户可以手动或使用脚本（如 PhysX 的 <a href="http://deploy.pl/">deploy.pl</a>）将构建物复制到适当的位置。这是非常临时性的，操作起来很简单。</p><p id="0ba9dcad-3a05-4cf3-b5f6-a9a7b3b5db24" class=""><strong>Stevedore in Bee：</strong>Stevedore in Bee 的方案中，我们需要准确分析，如果个别工件文件被修改，而不更新 .StevedoreVersion 文件的话，构建系统会有什么表现，目前还不清楚。</p></li></ol><ol type="1" id="9622088c-27c8-4517-8042-f81e5d8f62a2" class="numbered-list" start="10"><li>修改工作流程（ABV）<p id="52bae3f4-453e-420c-a7eb-00324c148dbb" class=""><strong>Largefiles：</strong>用户在 Katana 上构建一个新的 build.zip，从 Katana 下载，在主 repo 中提交，再将文件推送到 Ono，然后启动 ABV 做一个验证。</p><p id="8e00cf7e-a428-4f4b-9843-04919e5a2c02" class=""><strong>Stevedore：</strong>Stevedore 通过让 Katana 直接上传工件到 Artifactory，摆脱了这个愚蠢的 &quot;先下载，后上传 &quot;的过程。Katana 构建器提供了新的 build.zip 名称和版本，用户将其粘贴到清单中，提交，推送，并启动 ABV。除非用户想在本地进行测试，否则工件永远不需要下载到用户的电脑上。</p></li></ol><h2 id="788cf38c-26d2-4ed5-8311-3357ae3a1299" class="">3、相关资料</h2><p id="3d857ff6-335a-4446-8190-b98a09991973" class=""><a href="https://stevedore.unity3d.com/">Stevedore - Package Management System</a></p><p id="ca2293f8-eaa8-42db-aa8c-8b82ff6d9f6e" class=""><a href="https://confluence.unity3d.com/display/BST/Stevedore+-+Package+Delivery+Service">Stevedore - Package Delivery Service</a></p><p id="6fe3444c-8c90-40c7-9441-4f9b516c5d95" class=""><a href="https://confluence.unity3d.com/pages/viewpage.action?pageId=102667591">Development Guide (Stevedore - Package Manager)</a></p><p id="fff913e8-3494-4a86-b293-11e53777330a" class=""><a href="https://confluence.unity3d.com/pages/viewpage.action?pageId=105762428">Project Guide (Stevedore - Package Manager)</a>
<a href="https://docs.google.com/document/d/1koAUuidVsBnnlDFavUvHEqtGHS9hpRRmYjSkIX7kJyQ/edit#heading=h.8s6unqu359mf">Plans for a Dependency Manager - Google Docs</a></p><p id="4e4521da-f696-430b-aaea-bd2945bd33f6" class=""><a href="https://docs.google.com/document/d/1rfIP-Ncoj8OZUXhfBRyxLEIqIohXHL5ODjBP7KYY6PA/edit#heading=h.3uq8sp3vx23g">Stevedore artifact publishing guidelines - Google Docs</a></p><p id="5f1f04b1-4532-4df5-922e-ab1502cda8f4" class=""><a href="https://github.cds.internal.unity3d.com/unity/bee/blob/main/Bee.Stevedore.Program/StevedoreConfig.cs">Stevedore用到的URL</a>
<a href="https://github.cds.internal.unity3d.com/unity/stevedore-csharp-uploadtool">C#版上传到Stevedore工具</a></p><p id="9b8e1347-7900-43db-834e-4b6af2e67270" class=""><a href="https://github.cds.internal.unity3d.com/unity/repack-visual-studio">通过yamato部署到stevestore的demo</a></p><figure id="ecf2fed8-ab86-43cd-ae75-f8484fd9b1bc"><a href="https://artifactory.prd.it.unity3d.com/ui/repos/tree/General/stevedore-unity-internal" class="bookmark source"><div class="bookmark-info"><div class="bookmark-text"><div class="bookmark-title"></div></div><div class="bookmark-href">https://artifactory.prd.it.unity3d.com/ui/repos/tree/General/stevedore-unity-internal</div></div></a></figure><p id="381c17d9-3baa-493f-a586-794beec12683" class="">
</p><p id="508f2608-155d-454a-aa90-1fb6c6a8827d" class=""><a href="https://docs.google.com/document/d/1gmDWiu93Xm0TOxLNTSb1jI5kn55SEboRu0VCbJgUdCQ/edit#">Stevedore (DepMan) Background - Google Docs</a></p><p id="2fa7957d-fd35-4ba4-a423-2e63ebea6b1c" class=""><a href="https://docs.google.com/document/d/1fIaPkECGCAJYZpksUuphWUiBHHNq3wKwVXQZa4YCAqI/edit#heading=h.bb4wq96mklm1">Stevedore infrastructure - Google Docs</a>
<a href="https://github.cds.internal.unity3d.com/unity/stevedore-infra">Stevedore 服务</a></p><h1 id="5bf5a4ad-298c-403a-96c6-42ca32686d92" class="">四、也来看看Stevedore的架构</h1><h2 id="60565d0f-af4b-411f-aec9-f1bf9e7b1ac1" class="">1、Artifacts的管理和下载服务</h2><ul id="14fb226d-5377-4b31-80ec-2f7f0af98cc1" class="bulleted-list"><li>下载 Artifacts 需要两个重要信息： ArtifactID 和 RepoName。<ul id="433e73c3-a2c6-40a8-919b-fce079caa2b5" class="bulleted-list"><li>ArtifactID：  Artifact 的唯一标识，格式为 <code>{filename}-{platform}-{architecture}/{version.number}_{file_hash}.zip(7z)</code></li></ul><ul id="bb821b75-b9db-4a7f-90ab-bff9a0f9c63f" class="bulleted-list"><li>RepoName : 用来标识下载 URL 的前缀，与下文的&quot;保密等级&quot;相关</li></ul></li></ul><ul id="900ad899-702f-4b3b-a2a8-732a1b9481be" class="bulleted-list"><li>下载 Artifact 需要传入 Auth 信息，根据请求方式不同，分为：<ul id="64722404-cd55-4417-a9bd-884f7c9a97c3" class="bulleted-list"><li>基于 Header 的 Authorization</li></ul><ul id="5aea34ae-b10c-4603-8eb3-3e865c279e37" class="bulleted-list"><li>HTTP basic authorization</li></ul><ul id="83ef9339-513b-40b8-964f-84d5b8c4992f" class="bulleted-list"><li>OAuth authorization</li></ul></li></ul><h2 id="dc61f7cd-a435-40f5-8828-9e33a62e0de4" class="">2、Confidential &amp; Access Control</h2><h3 id="c50c8b1d-d8cf-4b7d-8d49-2d1a75c66025" class="">Artifact 我们有五个保密等级：</h3><ol type="1" id="cc1388f4-0f5e-4b96-83f7-5b2bdadcedb9" class="numbered-list" start="1"><li>pulic：我们可以不受限制地分享的工件（开源软件）。</li></ol><ol type="1" id="e7eaeb22-6ac1-4326-b7bb-e90098a46635" class="numbered-list" start="2"><li>main：主要的 Unity 代码库和通用工件，所有 Unity 员工和源代码客户都可以使用。</li></ol><ol type="1" id="13a451c2-c177-4ba3-9b59-06371c91c4b2" class="numbered-list" start="3"><li>unity-internal：不完全是秘密工件，但不能与源代码客户分享（如：苹果的 SDK）。</li></ol><ol type="1" id="a7b6b719-d846-43e4-89b0-a97070fa2e95" class="numbered-list" start="4"><li>consoles：与微软、任天堂、索尼这些公司的主机平台相关的工件，在前署对应协议之前，不能获取。 </li></ol><ol type="1" id="6a8ee56f-7576-4f97-b637-7fb5b6014d23" class="numbered-list" start="5"><li>“engine-wip“：绝对不可以被公开的部分，如果被发现，会迁移到其他地方去。</li></ol><h3 id="e36413f2-381a-4e32-9b5b-19ee87d21fab" class="">保密性由两个机制来保障：</h3><ul id="75f69ab5-17d3-4255-acad-264a592ee6ab" class="bulleted-list"><li>用户必须由必要的凭证来访问存储库</li></ul><ul id="f1526ddd-8383-432c-a64e-7766ad743e78" class="bulleted-list"><li>用户必须知道所需工件的确切名称和 SHA-256 哈希值，他们通常只能通过访问相应的代码来获得，但要遵守其自身的保密机制。（在 Stevedore 项目之外的情况）</li></ul><blockquote id="d95c1aa3-be55-493e-a359-0c7e92b69073" class="">为了防止枚举攻击（enumeration attacks），应该在工件服务器上禁用目录列表（或者限制为仅受信任的用户才能访问）。</blockquote><h3 id="cae77c9e-6835-4c3b-87da-7b1c842cf8d0" class="">访问控制摘要</h3><figure id="9d6d3906-ebc7-411e-8c98-85dc1496af05" class="image"><a href="index/Untitled%208.png"><img style="width:1254px" src="index/Untitled%208.png"/></a></figure><blockquote id="575edc3b-858a-421e-8385-bead77fb1425" class=""><strong>*</strong> 在这些情况下，用户将知道特定工件的存在（名称、版本和哈希值），但无法下载它。
<strong>†</strong> 在这些情况下，只有相关平台所有者批准的特定客户/合作伙伴可以下载。如果没有批准，那么他们只能了解工件的存在。
“Special Katana” 是能够访问 “engine-wip” 源代码和二进制文件的实例，但是不能允许它将秘密工件（意外地）上传到其他存储库中。</blockquote><h3 id="6ec42342-bb84-4193-8f30-34b119aaf1dc" class="">存储库清单</h3><p id="35ddad00-f59b-457e-b4fc-575952543f3c" class="">我们会有独立的存储库，以方便访问：</p><p id="392c549b-8680-4b40-a8b4-3dc06268b58e" class="">Public：</p><ul id="dfb4e7d0-9849-4495-a912-23d265a08a45" class="bulleted-list"><li>https://public-stevedore.unity3d.com/r/public/</li></ul><ul id="9b437f10-5d97-4c01-90d0-b854ed68e467" class="bulleted-list"><li>https://main-stevedore.unity3d.com/r/main/</li></ul><ul id="9186ae23-f32e-4691-9654-6e13449201fc" class="bulleted-list"><li>https://unity-internal-stevedore.unity3d.com/r/unity-internal/</li></ul><p id="d53283b8-900f-42d5-abb3-acf6edbd413a" class="">Consoles：</p><ul id="90616b6d-498b-4a45-872f-0393aa4225cc" class="bulleted-list"><li>https://ms-consoles-stevedore.unity3d.com/r/ms-consoles/</li></ul><ul id="aff0f94d-01e0-4c15-9d34-efa280c5dedd" class="bulleted-list"><li>https://sony-consoles-stevedore.unity3d.com/r/sony-consoles/</li></ul><ul id="3a48fe31-eec1-4c84-a3eb-bdde4091f9aa" class="bulleted-list"><li>https://nintendo-consoles-stevedore.unity3d.com/r/nintendo-consoles/</li></ul><p id="985c9386-d14a-499a-837b-66d892b900aa" class="">&quot;engine-wip&quot;（假设的范例）：</p><ul id="f6cd2ad6-4660-4cad-bab8-267929067261" class="bulleted-list"><li>https://neon-stevedore.unity3d.com/r/neon/</li></ul><ul id="19424750-37f2-4bef-8a15-62b79a4d30e4" class="bulleted-list"><li>https://argon-stevedore.unity3d.com/r/argon/</li></ul><ul id="184cb6b2-e0bc-43a2-a41f-26bb2bab0c4a" class="bulleted-list"><li>https://krypton-stevedore.unity3d.com/r/krypton/</li></ul><p id="c6eb8cbe-eec4-4a4e-baed-c1d4624514ae" class="">对于测试，我们有一个只能从公司办公室网络访问的独立服务器，它将提供 “testing” 资源库（类似于 unity-internal）。</p><ul id="3fa0ffd4-a1d2-47d9-b493-84e7468062ad" class="bulleted-list"><li>http://stevedore.hq.unity3d.com/r/testing/</li></ul><h2 id="c2a1eddc-dadf-417d-ad23-0657e4cc4b05" class="">3、Artifact Hosting requirement (用户数量，流量控制，存储管理，上传时间)</h2><h3 id="2ea3b6ac-87a6-48de-9429-a12cfbd95f14" class="">用户数量需求</h3><ul id="c7cec6f6-1a6f-43d5-9143-1f68d55b95d1" class="bulleted-list"><li>约 1000 名 Unity R&amp;D 的员工</li></ul><ul id="141187f2-1d4c-4526-84b5-432be3c9cf18" class="bulleted-list"><li>约 1000 个源代码客户和 shadow-repo 合作伙伴</li></ul><ul id="1b019e01-6a0c-4494-9c4d-09ef0ad536f6" class="bulleted-list"><li>约 10万名 Unity Pro 用户（Pro Source 如果得以实现）</li></ul><ul id="b913ddd7-724c-4c5f-9c1f-5a0352cb75fe" class="bulleted-list"><li>约 20万名 Tiny Unity 用户（估计日活跃用户）</li></ul><p id="9222ec42-171e-4553-8251-5d1fd512c427" class="">由于 Stevedore 的用户分布在世界各地，而且可能面临缓慢且不稳定的网络环境，因此在用户附近设置边缘节点的 CDN 是绝对有必要的。</p><p id="ac69d392-1a22-4df3-99a5-b9c1db0fb69a" class="">除了 CDN，我们还可以考虑本地办公室镜像，但是仅仅是办公室镜像还不是一个完整的解决方案，因为它们不能帮助到源代码客户和不在办公室的 Unity 员工。</p><h3 id="8a3141fa-0c1d-44ed-a80a-a0fe36c33161" class="">流量需求</h3><p id="72cdafe6-275c-4278-8f79-fb63964b215f" class="">典型用户的下载量预计可达 <strong>20GB/每年</strong> 的量级。</p><h3 id="03ef93e1-291c-4c5a-ad37-bb881ab0bba3" class="">存储需求</h3><p id="1c8cfcc8-c385-4783-b62d-a76511982cb3" class="">Ono 目前在所有分支和存储库中，新的工件（大文件形式）每年增长约 <strong>500GB </strong>。Stevedore 的存储需求开始时比这小得多，但是随着 Stevedore 取代现有的大文件，最终可能以类似的速度增长。</p><p id="3561aa1b-c44b-47e8-8f81-54d240978770" class="">此外，我们正考虑使发布新工件的流程变得更容易。</p><h3 id="14cad9d8-8fd7-4358-9279-412d1e477865" class="">正常运行时间上的需求</h3><p id="473e1eda-b567-445e-a71a-732bfaf36a2d" class="">正常运行时间上的需求度低，由于本地缓存，即使是几个小时的停机，通常也不会对大部分用户造成很大影响。用户也可以通过同事直接的拷贝来获取。</p><h3 id="428b8565-8a78-464d-bd0f-70624606e871" class="">记录/审查/报警 的需求</h3><ul id="8f0bdbf4-27c7-48f3-ae84-f64055de788a" class="bulleted-list"><li>任何记录都必须审查是否符合 GDPR。</li></ul><ul id="b886f931-7cad-471b-9f35-1a535d0aa4cb" class="bulleted-list"><li>常规的工件主机不需要保存下载日志。</li></ul><ul id="3ce6e15b-f1bc-4e5a-99f3-ebb7e72809a1" class="bulleted-list"><li>对于特别敏感的（“engine-wip”）存储库，可能需要保存下载日志。</li></ul><h2 id="fbc3cd44-f16a-403d-bfc5-01c0e6001c40" class="">4、OAuth and authorization</h2><p id="c30ef984-1332-4196-99be-2c25e15b522a" class="">目前Unity是使用OAuth的方法。stevedore并不直接从用户这里获取凭证(credential)，而是由google进行验证。随后用户将google所确认的凭证传给stevedore，而stevedore再与google所传递的凭证是否有效。以下为Website login flow主要流程示意图。</p><figure id="5da450de-2bc1-49d7-915b-2384167b1080" class="image"><a href="index/Untitled%209.png"><img style="width:1061px" src="index/Untitled%209.png"/></a></figure><p id="6d88f74b-5601-4536-9891-1e7b7d43299b" class="">在infra的源码中，<code>service/stevedore/www/__main__.py</code>所运行的www服务。可在<code>services/stevedore/www/flows</code>下看到<code>noborwer.py</code>, <code><a href="http://interactiveclientlogin.py/">interactiveclientlogin.py</a></code>, 以及<code><a href="http://websitelogin.py/">websitelogin.py</a></code>。其中websitelogin为最主要的，其他为无法正常工作的fallback。</p><ol type="1" id="22d4cf68-68f5-4678-acfb-b0a4e847171b" class="numbered-list" start="1"><li>用户访问某资源A，发现缺少token，被重定向至google，输入验证，并获取相应的auth。 </li></ol><ol type="1" id="05900beb-a15c-4dde-b965-a4cc9861e1a6" class="numbered-list" start="2"><li>用户访问stevedore端口获取传递google给的auth。<code>@endpoint_registry(&#x27;GET&#x27;, &#x27;/&#x27;, &#x27;code&#x27;, authz=http.authz_public)</code>。</li></ol><ol type="1" id="a2a9b55b-ee45-4d06-8d48-392ebace566d" class="numbered-list" start="2"><li>在验证中会先检查对应的hash，确认state或session是正确的。</li></ol><ol type="1" id="31ea6e37-be41-42fc-a621-a451228a6565" class="numbered-list" start="3"><li>发送post请求确认<code>token_url = &#x27;</code><code><a href="https://www.googleapis.com/oauth2/v4/token">https://www.googleapis.com/oauth2/v4/token</a></code><code>&#x27;</code>，用jwt对获取到的id_token解析，确认验证是否正确。将用户重定向至资源A。<p id="530c1f43-2bea-4fc5-b7b8-c03dcad4a411" class="">
</p></li></ol><pre id="441c9a83-1ee1-47a8-9d36-712dbcef2248" class="code"><code>def backend_authorization_response(cfg, req, backend_state):
    &quot;&quot;&quot; Verify that user was authenticated with backend. &quot;&quot;&quot;
    # Verify state / session.
    session_id = req.cookies.get(authn_session_cookie_name, &#x27;&#x27;)
    try:
        expected_session_hash = hashlib.sha256(util.base64url_decode(session_id)).digest()
        if not hmac.compare_digest(backend_state.session_hash, expected_session_hash):
            raise ValueError(&#x27;hash mismatch&#x27;)

    except ValueError:
        logger.warn(&#x27;AuthzWebsite: bad state %r, or mismatch with cookie %r = %r&#x27;, backend_state, authn_session_cookie_name, session_id, exc_info=True)
        # To prevent us from being a semi-open redirect, don&#x27;t redirect to the URL in backend_state.
        raise webob.exc.HTTPBadRequest(&#x27;Bad &quot;state&quot; or session cookie.&#x27;)

    req.delete_cookie(authn_session_cookie_name)

    # Verify auth code with backend authn server
    result = cfg.backend.exchange_authorization_grant(
        &#x27;authorization_code&#x27;,
        code=http.extract(req.GET, &#x27;code&#x27;, encoding=None),
        redirect_uri=cfg.backend.client_registration.redirect_uri,
    )
    login_token = cfg.website_login_session.make(
        email=result.email,
        u_refresh_token=result.refresh_token or &#x27;&#x27;,
    )
    req.set_cookie(login_session_cookie_name, login_token.decode(&#x27;ascii&#x27;))

    if backend_state.need_refresh_token and not result.refresh_token:
        raise webob.exc.HTTPForbidden(&#x27;Backend authentication server did not provide a refresh token.&#x27;)

    raise http.redirect(backend_state.redirect_url)</code></pre><h2 id="ac370bef-bb6c-4d13-a675-8a6324fb6ed1" class="">5、CDN and local office mirrors</h2><p id="70bdf53d-05e0-482a-a4d4-865eeecb7044" class="">
</p><figure id="f1869474-e9ee-4070-b06a-58235b75d4d1" class="image"><a href="index/Untitled%2010.png"><img style="width:1954px" src="index/Untitled%2010.png"/></a></figure><figure id="ee6c6315-9f00-4048-a971-64c4d33b4a27" class="image"><a href="index/Screen_Shot_2021-08-29_at_10.53.35_PM.png"><img style="width:1796px" src="index/Screen_Shot_2021-08-29_at_10.53.35_PM.png"/></a></figure><ul id="1e557ef0-e359-4d47-9d4d-2542f9279629" class="bulleted-list"><li><code>jam steve config</code> 检查目前使用的stevedore设置<pre id="0bbeeea9-965d-47b4-bf1b-07c27203935f" class="code"><code>PS F:\Unity\git\unity&gt; .\jam steve config
Config files:
  C:\Users\siyao\Stevedore.conf (not present)

Configuration:
  cache-folder = C:\Users\siyao\AppData\Local\Stevedore
  cache-folder.group-by-repo = false
  telemetry = anonymous
  telemetry.url = https://telemetry-stevedore.unity3d.com/v1/events
  timeout = 20000
  repo:* retries = 4
  repo:public = http://localhost:8080/r/public/ https://public-stevedore.unity3d.com/r/public/ https://public-stevedore.unitychina.cn/r/public/
  repo:testing = http://stevedore.hq.unity3d.com/r/testing/
  repo:unity-internal = http://stevedore.hq.unity3d.com/r/unity-internal/</code></pre></li></ul><p id="86f4c788-c63c-443f-bb72-e2171305fbcc" class=""><a href="https://unity.slack.com/archives/C1TGPS7UY/p1629275976045400">https://unity.slack.com/archives/C1TGPS7UY/p1629275976045400</a>
运行本地缓存</p><p id="0bec54d2-320a-4d94-abba-5398c54290d9" class=""><a href="https://github.cds.internal.unity3d.com/unity/stevedore-infra/tree/master/cache-server">https://github.cds.internal.unity3d.com/unity/stevedore-infra/tree/master/cache-server</a></p><p id="d282a39c-6262-4dc7-aae1-d431e1e76501" class="">可以看出本地缓存在AppData的local下。而本地起的cache端口为8080，并且注意放repo:public 时要加上<code>/r/public</code> 。如上 <code>repo:public = </code><a href="http://localhost:8080/r/public/"><code>http://localhost:8080/r/public/</code></a> ，会顺延着，第一个找不到，换上第二个。</p><p id="251e37de-0e47-4e8c-8d2c-8b657b93d88e" class="">参考：<div class="indented"><p id="5536cb12-d420-485c-a94e-dbfbb41a5e00" class="">https://github.cds.internal.unity3d.com/unity/bee/Bee.Stevedore.Program/StevedoreConfig.cs</p><pre id="6b93fdda-926d-4df5-8a67-e04ab579075e" class="code"><code>readonly Dictionary&lt;RepoName, RepoConfig&gt; m_RepoConfigs = new()
{
    { RepoName.Public, new RepoConfig(&quot;https://public-stevedore.unity3d.com/r/public/&quot;, &quot;https://public-stevedore.unitychina.cn/r/public/&quot;) },
    { (RepoName)&quot;testing&quot;, new RepoConfig(&quot;http://stevedore.hq.unity3d.com/r/testing/&quot;) },
    { (RepoName)&quot;unity-internal&quot;, new RepoConfig(&quot;http://stevedore.hq.unity3d.com/r/unity-internal/&quot;) },
};</code></pre></div></p><p id="1a3d09cf-a378-4ea9-9b76-f1ca3ad8241b" class="">
</p><p id="d43d0ed9-931c-4f51-b5ba-99db3a3facd8" class="">
</p><h1 id="9a9905ef-1357-4f50-a698-717d0d2792a4" class="">五、优雅的使用并剖析Stevedore</h1><h2 id="9c314b4a-a697-446a-aff2-5e2be8979bef" class="">1、Stevedore repositories 种类</h2><p id="b1da4715-7420-4d01-9149-3b77945b194f" class="">
</p><p id="954e6af4-01fe-4b9b-9908-1e35816afad7" class="">使用和剖析之前我们需要了解Stevedore repositories 种类如下：</p><ul id="2faa0bb8-5f80-46ad-8f34-a63c0e5f9d72" class="bulleted-list"><li>testing:   仅限unity员工, 可以自由上传到该repo下;</li></ul><ul id="0e2fa3b8-52c2-4fbc-91d1-ab567bbf7b2e" class="bulleted-list"><li>unity-internal:  仅限unity员工</li></ul><ul id="a54bcfcf-dd6c-4065-b6fe-ab7720a23afc" class="bulleted-list"><li>public: 不要求认证权限 (员工, 源代码客户和合作伙伴)</li></ul><ul id="22a91846-56de-4adb-8c25-e4a014814c21" class="bulleted-list"><li>main:  可供员工和所有源代码客户使用, 但需要认证;</li></ul><ul id="bb9cb355-1032-4d3a-b670-92ab800c14e3" class="bulleted-list"><li>*-consoles: 可供员工和已用于该平台权限的（Microsoft/Nintendo/Sony）源代码客户访问, 也同样需要认证。</li></ul><p id="20b3c2f2-6509-41b8-b5c2-395203e1641b" class="">
</p><div id="5ffa4433-dff4-4051-8d68-404c3180f53f" class="collection-content"><h4 class="collection-title">Copy of repo 访问详情</h4><table class="collection-content"><thead><tr><th><span class="icon property-icon"><svg viewBox="0 0 14 14" style="width:14px;height:14px;display:block;fill:rgba(55, 53, 47, 0.4);flex-shrink:0;-webkit-backface-visibility:hidden" class="typesTitle"><path d="M7.73943662,8.6971831 C7.77640845,8.7834507 7.81338028,8.8943662 7.81338028,9.00528169 C7.81338028,9.49823944 7.40669014,9.89260563 6.91373239,9.89260563 C6.53169014,9.89260563 6.19894366,9.64612676 6.08802817,9.30105634 L5.75528169,8.33978873 L2.05809859,8.33978873 L1.72535211,9.30105634 C1.61443662,9.64612676 1.2693662,9.89260563 0.887323944,9.89260563 C0.394366197,9.89260563 0,9.49823944 0,9.00528169 C0,8.8943662 0.0246478873,8.7834507 0.0616197183,8.6971831 L2.46478873,2.48591549 C2.68661972,1.90669014 3.24119718,1.5 3.90669014,1.5 C4.55985915,1.5 5.12676056,1.90669014 5.34859155,2.48591549 L7.73943662,8.6971831 Z M2.60035211,6.82394366 L5.21302817,6.82394366 L3.90669014,3.10211268 L2.60035211,6.82394366 Z M11.3996479,3.70598592 C12.7552817,3.70598592 14,4.24823944 14,5.96126761 L14,9.07922535 C14,9.52288732 13.6549296,9.89260563 13.2112676,9.89260563 C12.8169014,9.89260563 12.471831,9.59683099 12.4225352,9.19014085 C12.028169,9.6584507 11.3257042,9.95422535 10.5492958,9.95422535 C9.60035211,9.95422535 8.47887324,9.31338028 8.47887324,7.98239437 C8.47887324,6.58978873 9.60035211,6.08450704 10.5492958,6.08450704 C11.3380282,6.08450704 12.040493,6.33098592 12.4348592,6.81161972 L12.4348592,5.98591549 C12.4348592,5.38204225 11.9172535,4.98767606 11.1285211,4.98767606 C10.6602113,4.98767606 10.2411972,5.11091549 9.80985915,5.38204225 C9.72359155,5.43133803 9.61267606,5.46830986 9.50176056,5.46830986 C9.18133803,5.46830986 8.91021127,5.1971831 8.91021127,4.86443662 C8.91021127,4.64260563 9.0334507,4.44542254 9.19366197,4.34683099 C9.87147887,3.90316901 10.6232394,3.70598592 11.3996479,3.70598592 Z M11.1778169,8.8943662 C11.6830986,8.8943662 12.1760563,8.72183099 12.4348592,8.37676056 L12.4348592,7.63732394 C12.1760563,7.29225352 11.6830986,7.11971831 11.1778169,7.11971831 C10.5616197,7.11971831 10.056338,7.45246479 10.056338,8.0193662 C10.056338,8.57394366 10.5616197,8.8943662 11.1778169,8.8943662 Z M0.65625,11.125 L13.34375,11.125 C13.7061869,11.125 14,11.4188131 14,11.78125 C14,12.1436869 13.7061869,12.4375 13.34375,12.4375 L0.65625,12.4375 C0.293813133,12.4375 4.43857149e-17,12.1436869 0,11.78125 C-4.43857149e-17,11.4188131 0.293813133,11.125 0.65625,11.125 Z"></path></svg></span>Repo</th><th><span class="icon property-icon"><svg viewBox="0 0 14 14" style="width:14px;height:14px;display:block;fill:rgba(55, 53, 47, 0.4);flex-shrink:0;-webkit-backface-visibility:hidden" class="typesMultipleSelect"><path d="M4,3 C4,2.447715 4.447715,2 5,2 L12,2 C12.5523,2 13,2.447716 13,3 C13,3.55228 12.5523,4 12,4 L5,4 C4.447715,4 4,3.55228 4,3 Z M4,7 C4,6.447715 4.447715,6 5,6 L12,6 C12.5523,6 13,6.447716 13,7 C13,7.55228 12.5523,8 12,8 L5,8 C4.447715,8 4,7.55228 4,7 Z M4,11 C4,10.447715 4.447715,10 5,10 L12,10 C12.5523,10 13,10.447716 13,11 C13,11.55228 12.5523,12 12,12 L5,12 C4.447715,12 4,11.55228 4,11 Z M2,4 C1.44771525,4 1,3.55228475 1,3 C1,2.44771525 1.44771525,2 2,2 C2.55228475,2 3,2.44771525 3,3 C3,3.55228475 2.55228475,4 2,4 Z M2,8 C1.44771525,8 1,7.55228475 1,7 C1,6.44771525 1.44771525,6 2,6 C2.55228475,6 3,6.44771525 3,7 C3,7.55228475 2.55228475,8 2,8 Z M2,12 C1.44771525,12 1,11.5522847 1,11 C1,10.4477153 1.44771525,10 2,10 C2.55228475,10 3,10.4477153 3,11 C3,11.5522847 2.55228475,12 2,12 Z"></path></svg></span>访问权限</th><th><span class="icon property-icon"><svg viewBox="0 0 14 14" style="width:14px;height:14px;display:block;fill:rgba(55, 53, 47, 0.4);flex-shrink:0;-webkit-backface-visibility:hidden" class="typesCheckbox"><path d="M0,3 C0,1.34314 1.34326,0 3,0 L11,0 C12.6567,0 14,1.34314 14,3 L14,11 C14,12.6569 12.6567,14 11,14 L3,14 C1.34326,14 0,12.6569 0,11 L0,3 Z M3,1.5 C2.17139,1.5 1.5,2.17157 1.5,3 L1.5,11 C1.5,11.8284 2.17139,12.5 3,12.5 L11,12.5 C11.8286,12.5 12.5,11.8284 12.5,11 L12.5,3 C12.5,2.17157 11.8286,1.5 11,1.5 L3,1.5 Z M2.83252,6.8161 L3.39893,6.27399 L3.57617,6.10425 L3.92334,5.77216 L4.26904,6.10559 L4.44531,6.27582 L5.58398,7.37402 L9.28271,3.81073 L9.45996,3.64008 L9.80664,3.3056 L10.1538,3.63989 L10.3311,3.81067 L10.8936,4.35303 L11.0708,4.52399 L11.4434,4.88379 L11.0708,5.24353 L10.8936,5.41437 L6.1084,10.0291 L5.93115,10.2 L5.58398,10.5344 L5.23682,10.2 L5.05957,10.0292 L2.83057,7.87946 L2.65283,7.70801 L2.27832,7.34674 L2.6543,6.98694 L2.83252,6.8161 Z"></path></svg></span>是否需要认证</th></tr></thead><tbody><tr id="29280d88-3958-4e4e-97b0-5c05918f66a5"><td class="cell-title"><a href="https://www.notion.so/testing-29280d8839584e4e97b05c05918f66a5">testing</a></td><td class="cell-QYW?"><span class="selected-value select-value-color-gray">employee</span></td><td class="cell-XWq?"><div class="checkbox checkbox-off"></div></td></tr><tr id="36a0b239-b8f2-48b7-b3cb-414372e54fd5"><td class="cell-title"><a href="https://www.notion.so/unity-internal-36a0b239b8f248b7b3cb414372e54fd5">unity-internal</a></td><td class="cell-QYW?"><span class="selected-value select-value-color-gray">employee</span></td><td class="cell-XWq?"><div class="checkbox checkbox-off"></div></td></tr><tr id="f78084e7-a98f-4f29-a427-1e108f9967ee"><td class="cell-title"><a href="https://www.notion.so/public-f78084e7a98f4f29a4271e108f9967ee">public</a></td><td class="cell-QYW?"><span class="selected-value select-value-color-gray">employee</span><span class="selected-value select-value-color-purple">partner</span><span class="selected-value select-value-color-brown">source code customer</span></td><td class="cell-XWq?"><div class="checkbox checkbox-off"></div></td></tr><tr id="e450e2ee-f3b3-4b65-947f-7379964e0162"><td class="cell-title"><a href="https://www.notion.so/main-e450e2eef3b34b65947f7379964e0162">main</a></td><td class="cell-QYW?"><span class="selected-value select-value-color-gray">employee</span><span class="selected-value select-value-color-brown">source code customer</span></td><td class="cell-XWq?"><div class="checkbox checkbox-on"></div></td></tr><tr id="36c1c37e-99d4-483c-9928-03e2bf565162"><td class="cell-title"><a href="https://www.notion.so/console-36c1c37e99d4483c992803e2bf565162">*-console</a></td><td class="cell-QYW?"><span class="selected-value select-value-color-pink">customer approved by console owner</span><span class="selected-value select-value-color-gray">employee</span></td><td class="cell-XWq?"><div class="checkbox checkbox-on"></div></td></tr></tbody></table></div><p id="96d4a9de-f6d3-43b6-8f8f-812b34521d3a" class="">
</p><h2 id="1c8c7054-ab47-4492-a29e-187509eff472" class="">2、构建 &amp; 上传 新的Artifacts到Stevedore 流程</h2><h3 id="9957d72c-745f-43d8-bd42-fd9786eba356" class="">1、手动上传artifact</h3><p id="02c151a9-a4d4-4ac1-b71d-9a3109b1bf4f" class="">首先为 artifact 产生一个 artifactId，格式为 <code>{filename}-{platform}-{architecture}/{version.number}_{file_hash}.zip(7z)</code> 。</p><p id="ccc4920f-7f41-43b0-8bba-6f86ed130886" class="">其中文件哈希部分使用的是 sha256 算法，可通过下列方式生成：<div class="indented"><p id="353dd0f7-9f34-4011-be73-2266370cbf91" class=""><strong>其他平台:</strong>    <mark class="highlight-gray">bee.exe steve new PATH ARTIFACT-NAME VERSION-STRING</mark>
<strong>Mac:</strong>           <mark class="highlight-gray">shasum -a 256 PATH</mark>
<strong>Linux :</strong>        <mark class="highlight-gray">sha256sum  PATH</mark>
<strong>Windows</strong>:  <mark class="highlight-gray">Get-FileHash -Algorithm SHA256 PATH</mark></p></div></p><p id="123005e9-bf3c-4087-bc5d-eb3f15bcd851" class="">然后按照 <a href="https://stevedore.unity3d.com/upload/">https://stevedore.unity3d.com/upload/</a> 上的说明将文件上传到“测试”存储库。</p><figure id="d3297888-0c6c-4668-8586-de265e3c2193" class="image"><a href="index/man-upload.jpg"><img style="width:1594px" src="index/man-upload.jpg"/></a></figure><p id="bd4938a0-a31f-4306-9b41-8d8c499bfbf4" class="">完成测试，请在#devs-stevedore 上要求将artifact 上传到 Stevedore  prod存储库上，例如“public”或 “unity-internal” repo下。</p><p id="1be5b8c0-8fe0-40fd-9a99-482eb36dd39c" class="">
</p><h3 id="74032737-5562-48b9-adfa-a75c2aa172f5" class="">2、自动化构建上传artifact</h3><p id="7785a35f-6cba-450c-b826-642b261eb5d3" class="">
</p><p id="27c56586-4e0f-4e05-8079-3edd2f8bdfe3" class=""><strong>通常，从源代码repo构建的所有artifacts都应使用构建自动化创建，而不是手动创建, 以防止手动修改</strong></p><p id="7e89b4d9-1583-43eb-a0f2-5742e0651ed8" class="">
</p><p id="acbb9b98-9a9e-4764-a334-c348d90276ff" class="">(1)  创建一个artifact. </p><pre id="55f35113-d8c6-4702-b12c-fbbb4b551ec2" class="code"><code>void SetupStevedoreArtifact(NativeProgramConfiguration config, CSharpProgram program)
{
    // 适用的平台/架构, e.g. &quot;win-x86&quot; or &quot;linux-x64&quot;.
    var suffix = $&quot;{config.Platform.DisplayName.ToLower()}-{config.ToolChain.Architecture.DisplayName}&quot;;

    var artifactPath = new NPath($&quot;artifacts/for-stevedore/hello-{suffix}.7z&quot;);

    var contents = new ZipArchiveContents();
    // 添加License
    contents.AddFileToArchive(&quot;LICENSE.md&quot;);
    // 删除归档中的路径
    contents.AddFileToArchive(program.Path, program.Path.FileName);
    ZipTool.SetupPack(artifactPath, contents);
}</code></pre><p id="32638739-40a6-4fae-a1dd-49a4b8adac42" class="">
</p><p id="9dc345f3-dc6c-429c-b06f-d81617e41576" class="">(2) 生成上传密钥.</p><p id="d4b80df4-90ac-4bd9-845d-b7733a3a4893" class="">要在构建自动化后上传，需要一个上传密钥（推荐使用更细粒度的密钥, 以提高安全性）。
详细说明请<a href="https://stevedore.unity3d.com/upload/keys">点击此链接</a> </p><p id="8380d78a-6ab0-424d-a300-ce08fc36d9ce" class="">使用 artifact名称 以及 电子邮件生成密钥对.</p><p id="bea1287b-136c-46a6-9555-d80865539e66" class="">
</p><p id="6260b1ff-4f2e-4f29-b7b3-8c3b64993beb" class="">(3) 选择Katana | Yamato 上传.</p><ul id="e703baa8-28f3-4b96-891a-0f09e81b97c8" class="bulleted-list"><li>Yamato</li></ul><p id="8369af75-6343-48d2-bc8f-9061028a257c" class="">有时候访问页面需要连接VPN</p><p id="8672506a-8af8-49fc-91ae-b247afe18abe" class="">流程如下:</p><figure id="7ad178e7-b5b6-40bd-93a1-6557b6ef2a3d" class="image"><a href="index/upload.png"><img style="width:2411px" src="index/upload.png"/></a></figure><p id="a1c8fa35-00dd-44de-8068-440192cd7166" class="">(1) 创建一个Yamato project, </p><p id="f4d781d2-8754-4f14-9912-788455b726d6" class="">
</p><p id="2059f469-63b2-44ea-a7fc-02860f9e3010" class="">(2) 创建一个跟project同名的Secret group;</p><figure id="ff86340d-242f-4277-9354-5eaffa5cc5c9" class="image"><a href="index/1.png"><img style="width:1494px" src="index/1.png"/></a></figure><p id="2beed101-c138-474b-9b84-2288f9456108" class="">
</p><p id="0c712577-47d1-4cfa-84dd-ebfcc8e4ae63" class="">(3) 在project设置里面添加上一步创建的secret group, 以及<code>stevedore-upload</code>group. </p><figure id="0f3ee990-75ee-4ee3-b7df-532f19a0b54b" class="image"><a href="index/2.png"><img style="width:1656px" src="index/2.png"/></a></figure><p id="9adf9aa8-135b-4a9c-964f-c60735fad01b" class="">
</p><p id="f52dc5e3-2c1f-4944-8e86-ff4a605241d3" class="">添加stevedore-upload group 需要进行审核, 可以在 <mark class="highlight-brown"><strong>#devs-stevedore </strong></mark>channel 请求权限;</p><figure id="b757d858-2f47-468e-890a-ab9fdd0c5073" class="image"><a href="index/3.png"><img style="width:1570px" src="index/3.png"/></a></figure><p id="b5836409-2ae4-4559-9ed1-f8205c4ac52d" class="">
</p><p id="223dbd50-90fb-4614-8f49-5a851cb309e0" class="">(4) 在项目跟路径下创建一个<code>.yamato</code>文件夹, 并创建一个yml脚本.</p><pre id="5d72c9b3-cc45-4513-aeab-a977a9f2226c" class="code"><code>hello-cs2021:
  name: hello-cs2021
  agent: 
    type: Unity::VM
    image: slough-ops/win10-base:stable
    flavor: b1.medium

  commands:
    - curl.exe -sSo StevedoreUpload.exe &quot;%STEVEDORE_UPLOAD_TOOL_URL%&quot;
    - StevedoreUpload.exe --version-len=12 --repo=testing --version=&quot;%GIT_REVISION%&quot; artifacts/for-stevedore/*</code></pre><p id="1742a0f1-0483-464c-b315-2efd685b9f6a" class="">
</p><p id="0991bf67-71c2-4752-88ca-a374dc4c8cb8" class="">
</p><h3 id="3ee3c214-3770-4ee7-b344-1c406567d477" class="">3、关于Artifact取名的一些要求</h3><p id="5512834a-b329-46ae-a804-4a986c9c6bf3" class="">1）、Artifact name</p><p id="dd3861f9-e260-479f-bc3a-ebbae803ad8e" class="">如果不同平台需要不同版本的artifact，请确保包含平台/架构后缀。 
<code>示例：emscripten-llvm-win-x64</code></p><p id="ed991919-58b3-4a17-8e3f-6848d5bafeeb" class="">⚠️   名称只能包含 ASCII 字母、数字、连字符和下划线，且最多 28 个字符（Windows 路径长度问题）</p><p id="1b8abaee-db23-4ec0-9bc1-3fe08d1a271a" class="">
</p><p id="ae0b7c8c-8cd5-4df8-82ef-0738429aa0c7" class="">2）、Artifact version</p><p id="e2dc82c0-8630-4e22-97de-08b30a39593a" class="">如果是第三方下载, 请按原样使用版本字符串。 </p><p id="acabb06d-87d1-4683-a20c-e977a4d2460f" class="">如果该artifact是 “自制的”，或已修改过第三方资源，不要按原样使用版本号，请添加诸如像-unity这样的后缀。
如果artifact是使用来自 Git 或 Hg 存储库的构建自动化（“CI”）构建的，版本字符串最好简化为12 个字符的哈希值.</p><p id="8825ba2c-0cd9-47a8-89d2-a8b94a8b8959" class="">⚠️  只能包含 ASCII 字母、数字和特殊字符 -(),.=@[]_，并且最多 40 个字符.</p><p id="9753db10-fe59-4302-8ae7-37ab62773157" class="">
</p><p id="dda82225-c95e-466c-abeb-f522282b6499" class="">3）、Artifact content</p><ul id="cafdd786-a98b-4133-81d6-2c48473e587a" class="toggle"><li><details open=""><summary>根目录下必须包含<code>LICENSE</code>文件</summary><p id="5400f45e-b7d9-4672-9f18-cb38f2083079" class="">unity-internal repo下的artifacts可酌情忽略</p></details></li></ul><ul id="1b066fe6-a866-4bd5-91fd-5388c82f169c" class="toggle"><li><details open=""><summary>避免artifact路径中存在版本号</summary></details></li></ul><ul id="14e067ad-5041-4372-9f3e-614e17bb1787" class="toggle"><li><details open=""><summary>并不需要额外创建一个根目录</summary></details></li></ul><ul id="134ee9d6-2ac9-4e27-b478-136dc1183f72" class="toggle"><li><details open=""><summary>不要包含readme, 源码已经测试用例代码</summary></details></li></ul><p id="89091642-af54-4cd9-aa36-7496f750b187" class="">
</p><h2 id="5f9ba8fe-0d85-41d0-bc5e-e602e138f6d0" class="">3、Stevedore在Unity build系统中的应用</h2><p id="1e014863-cd96-404a-8a5f-36876180e07f" class="">
</p><h3 id="80969452-cd30-434d-9e79-654ce06d56ef" class="">1、Stevedore.manifest</h3><p id="11e21ade-f2d5-46ea-b4bc-927ca26fdb8d" class="">
</p><p id="34cff587-086a-44db-8c80-fc983f44104b" class="">manifest 是一个简单的文本文件（带有 .stevedore 扩展名) , 可参考<code>bee_bootstrap.manifest.stevedore</code>. 每行列出一个artifact ID，以及它的存储仓库地址, 例如:</p><pre id="08d5f0af-ded2-4959-ae81-ac1117784845" class="code"><code>public: 7za-win-x64/16.04-1.1.4_0d1e6ad367de3bb0c1a396856903c63e080a1e8fee52897cb5f5dee063832831.zip</code></pre><p id="ed787dc6-a432-4a09-a5bc-dd19ebf8cb7d" class="">manifest中列出的存储仓库名称和atrifact版本优先于构建代码中指定的任何内容。 例如 即使构建代码要求.</p><pre id="c0e7ad27-67b6-4525-8c89-8cf86dfd487a" class="code"><code>StevedoreArtifact.UnityInternal(&quot;7za-win-x64/18.01-1.4.7_abc...def.zip&quot;)</code></pre><p id="8fbe60bd-c710-4b63-a136-bc2ef25a6ae9" class="">Stevedore 还是将从public存储库（如清单中指定的）获取版本 16.04.</p><p id="c00c41b7-1e50-480f-b9b7-79868f28d95e" class="">官方建议使用manifest，因为查看manifest文件, 就可以获得所有用到的 Stevedore artifacts。</p><p id="ce9bd8f0-a727-4d06-9c2a-6803e5226ed7" class="">由于manifest提供了artifact的存储库名称和版本，下载其代码可以简化为：</p><pre id="2da84e71-41a0-4eb5-bbe0-aef63b8dd31b" class="code"><code>new StevedoreArtifact(&quot;7za-win-x64&quot;)</code></pre><figure id="22f5b493-5cfc-4a47-bf7c-019412afd852" class="image"><a href="index/4.jpg"><img style="width:1754px" src="index/4.jpg"/></a></figure><p id="00320516-64d4-466b-8a6b-d42abe17c533" class="">
</p><h3 id="9a11a604-bfd4-4844-a20d-af26320b5880" class="">2、下载及使用已下载的Artifacts</h3><p id="c694b69c-369f-478b-8e80-0a73b199a8fa" class="">
</p><p id="1f363b4e-a668-40b4-8166-58f1999e7b29" class="">ArtifactId 可通过<a href="https://stevedore.unity3d.com/list/">列表</a>查询</p><p id="efee625d-d164-42b0-8c24-944ebd3ed9bb" class="">在使用该函数下载文件时, 会看到该artifact的路径显示为 <code>/VirtualStevedoreRoot/public/ArtifactId</code>, 显示的为虚拟路径. 只要在对其路径调用 ResolveWithFileSystem() 或者 InQuotesResolved() 才会真正执行下载解压. 这正是之前提到的 IBackendRegistrable() 类不再需要的原因, 文件是自动解析的.</p><pre id="30d78978-1873-4b7d-b63f-acc8bae655d7" class="code"><code>// download &amp; unpack
var artifact = StevedoreArtifact.Public(string ArtifactId);
// This allows the SteveVirtualFileSystem to setup the unpacks
artifact.Path.ResolveWithFileSystem();</code></pre><figure id="d5024c60-6516-4fc6-8509-8ca7697c6f4c" class="image"><a href="index/1%201.png"><img style="width:1668px" src="index/1%201.png"/></a></figure><p id="c3f6e965-95a5-4dde-bb42-1bf74a0dce92" class="">
</p><p id="c1306aca-1683-4c28-bf01-b03d1d277fed" class="">
</p><h3 id="40552d23-a5e2-4b09-bf12-768882f271d2" class="">3、Artifacts本地版本管理和更新</h3><p id="6172d749-6812-440b-8d33-30192d6346cc" class="">
</p><p id="d6c9fc0c-dca7-43c5-9200-89cad5fd1468" class="">在成功下载解压artifact后, 会在该目录下生成一个<code>.StevedoreVersion</code>文件, 包含当前artifact的repo 及 id. </p><p id="8bbfd495-ff11-434a-8abd-3e379b7b5a54" class="">
</p><p id="f1218d06-cb40-469d-9410-4bcd21ed8eaf" class="">参考链接</p><ul id="9679634f-3270-4b6a-84f3-87200a7b9703" class="bulleted-list"><li> <a href="https://github.cds.internal.unity3d.com/unity/repack-visual-studio">https://github.cds.internal.unity3d.com/unity/repack-visual-studio</a></li></ul><p id="cb3b5972-cfbc-46ed-a275-c06db7865f5c" class="">
</p><p id="e1bf4f74-d9ee-4816-960b-e4e91a696d3c" class="">Demo code</p><ul id="a5ec0fdd-2092-4d8a-943d-c03c194188ca" class="bulleted-list"><li><a href="https://github.cds.internal.unity3d.com/yuting-chen/learning-bee/tree/main/01_CompileCSharp">https://github.cds.internal.unity3d.com/yuting-chen/learning-bee/tree/main/01_CompileCSharp</a></li></ul><h1 id="8bf0f9b1-32f7-4955-a8bb-0cfbb23d99ba" class="">六、Stevedore在Bee中如何被整合的</h1><p id="86e1ee6c-6883-4a9c-95ab-a648afcc8318" class="">
</p><p id="0153324e-bde2-47af-a1a2-29953fc9f9f6" class="">stevedore  部分代码主要是在 以下两个里面</p><ul id="f5a9ef48-9089-405d-b58b-25939f8efdf0" class="bulleted-list"><li>Bee.Core.Stevedore</li></ul><ul id="2042f694-fead-4b91-a92c-68f2a219e0c4" class="bulleted-list"><li>Bee.Stevedore.Program</li></ul><p id="dcd9d1e5-a68d-435a-b92a-ec845027fbc8" class="">
</p><p id="6200953c-438a-4762-8507-2d7f82531832" class="">这边讲粗略的介绍给各自里面有哪些功能方法，然后着重介绍下上面出现的几个比较重要的概念。</p><p id="adca88af-db5a-4a17-a907-db4f846ed7ba" class="">
</p><h3 id="e12f2ea1-5ad3-4d40-974b-c948fa8af458" class="">1、Bee.Core.Stevedore</h3><p id="2f2702d2-ce6e-42da-913a-8694ee57419b" class="">代码下文件列表如下：</p><figure id="f7eccfc2-5b5d-4023-a34f-09ae03d1e753" class="image"><a href="index/Untitled%2011.png"><img style="width:410px" src="index/Untitled%2011.png"/></a></figure><p id="5a350a46-e905-4de8-a1b5-0206b0e2cef9" class="">
</p><p id="9fb65927-b91f-4188-a475-1718dbac74e3" class="">
</p><figure id="ed87ae54-791e-453a-b20c-7c1a462a30dd" class="image"><a href="index/3d38d650441c48e7c2aa8c90972fa35.png"><img style="width:949px" src="index/3d38d650441c48e7c2aa8c90972fa35.png"/></a></figure><p id="c5ca99a1-4aa8-42ef-a204-4ed6fd6d7585" class="">该包中的内容用来在构建代码过程中处理Stevedore artifacts的api。其中最重要的是下面这两个class，其他的基本都是为它们服务的</p><ol type="1" id="6265c020-24ff-491f-9e03-293d7f4cbf35" class="numbered-list" start="1"><li>StevedoreArtifact：表示一个 Stevedore 包，其中包含用于构造工件、确定其解包位置、获取其文件列表等的方法（与 Unity 构建系统的BuildZipArtifact类相当）。</li></ol><ol type="1" id="6f16d728-623a-44c3-8fe8-e69248981918" class="numbered-list" start="2"><li>StevedoreSettings： 定义StevedoreArtifact特定于后端的相关设置。</li></ol><p id="8a959f2e-3ed1-431d-baeb-3aa545a30d25" class="">
</p><p id="a02e1437-a537-4fde-8671-f9a1c238d304" class="">
</p><p id="03386e18-97ed-4ae1-9120-711f50433b62" class="">先讲一些其他的class：</p><ol type="1" id="14232345-8298-4e20-be86-c7e02de4154c" class="numbered-list" start="1"><li>class SteveVirtualFileSystem <p id="6ceb915c-88e7-4dba-824e-27ae41cc7295" class="">SteveVirtualFileSystem 负责检测虚拟路径，是在StevedoreArtifact中使用的，在StevedoreArtifact中的用法主要由三个：</p><p id="cb856522-3bb5-4819-a9d9-de06411ef0c4" class="">（1）根据当前活动的清单解析 StevedoreArtifact。</p><p id="93b02102-1bdd-48f3-8832-6d6d8d0f454e" class="">（2）确保在后端设置了 steve unpack 操作，该操作负责将已解析的包解压到真实的文件系统目录中。</p><p id="00918bff-7025-41b7-a554-c8ddc8b86d47" class="">（3）确保真正的文件系统目录（解析路径）在 tundra.dag.json 中结束。</p></li></ol><ol type="1" id="485d2f6a-25b6-40e7-ba96-281dc78b79db" class="numbered-list" start="2"><li>class StevedoreUnpacker<p id="07a86be2-7f78-4018-a6ed-b640aee1609f" class="">StevedoreUnpacker可验证工件是否可用，读取artifact文件列表，安装，拆包等。</p><ul id="307bb603-4ea6-4e85-80d0-593baef522c3" class="bulleted-list"><li>internal StevedoreUnpacker(Backend backend)（设置后端，读取环境默认值。创建DownloadCache）</li></ul><ul id="40129620-15fc-4a2c-9c13-a6f6669c9694" class="bulleted-list"><li>void VerifyRepositoryForArtifactIsAvailable(ResolvedStevedoreArtifact artifact)（验证 RepoName 是否指定了实际配置的存储库，验证存储库实际上是否可用，如果工件已经缓存是很好的）</li></ul><ul id="8e0affe3-0e08-45ed-afd9-528aec2c9120" class="bulleted-list"><li>public NPath[] ReadFileListFor(StevedoreArtifact artifact)（读取文件列表）</li></ul><ul id="cba6a438-475d-439d-8575-e5ab7fd12ad6" class="bulleted-list"><li>void SetupUnpack(ResolvedStevedoreArtifact resolvedArtifact, NPath resolvedTargetDir, NPath resolvedArtifactVersionFile)（安装，拆包）</li></ul></li></ol><p id="a3aef53c-099a-489c-8eaf-41939f585489" class="">再讲一下StevedoreArtifact和StevedoreSettings：</p><ol type="1" id="d77daeae-4dea-46c9-9a53-92713eac5671" class="numbered-list" start="3"><li>class StevedoreArtifact<ul id="f582ca1d-3108-4be3-9936-63f99378bf17" class="bulleted-list"><li>public static StevedoreArtifact Public(string artifactId) （创建一个源自“Public”Stevedore 存储库的 StevedoreArtifact）</li></ul><ul id="0439a3f1-00b1-426b-af84-354fd925edb7" class="bulleted-list"><li>public static StevedoreArtifact Testing(string artifactId)（创建一个源自“Testing”Stevedore 存储库的 StevedoreArtifact）</li></ul><ul id="cc670bd5-9ea8-48a7-8eab-425ca070d303" class="bulleted-list"><li>public static StevedoreArtifact UnityInternal(string artifactId)（创建一个源自“UnityInternal”Stevedore 存储库的 StevedoreArtifact）</li></ul><ul id="c8047f50-3c7f-456b-9d6f-d5e3d27f54db" class="bulleted-list"><li>public static StevedoreArtifact FromLocalFile(string artifactName, NPath source)（创建一个已经存在于本地存储库中的 StevedoreArtifact，因此不用下载。 仅打算作为一种过渡措施，允许将 Stevedore API 用于现有的大文件，直到它们被移动到适当的 Stevedore 服务器。）</li></ul><ul id="a0f78970-c20f-4f14-b30a-543a8dffa14f" class="bulleted-list"><li>public bool IsByNameOnly（StevedoreArtifacts 可以仅按名称创建，也可以按特定的存储库、名称和版本创建。 IsByName 让您知道使用了哪个。）</li></ul><ul id="70b9d91f-a85b-4a24-9bac-cfee34ef0661" class="bulleted-list"><li>public RepoName RepoName（此 StevedoreArtifact 的 RepoName。 如果您确定此 StevedoreArtifact 是使用 RepoName 创建的，则仅查询此属性。）</li></ul><ul id="49c6b767-a71d-46a6-a839-c399b14acd5d" class="bulleted-list"><li>public ArtifactId ArtifactId（此 StevedoreArtifact 的 ArtifactId。 如果您确定此 StevedoreArtifact 是使用 ArtifactId 创建的，则仅查询此属性。）</li></ul><ul id="0426357c-e236-4179-ae9a-6cffe0c7b8d4" class="bulleted-list"><li>public NPath Path（返回表示此stevedore artifact的虚拟路径。 像 /VirtualStevedoreRoot/public/roslyn-csc-win64/... 并且可以通过 NPath 和 Backend.Current 安全使用）</li></ul><ul id="7c3b6307-46ab-4f92-acf6-dd2bb0e4f9d2" class="bulleted-list"><li>public string VersionString（artifact版本的“版本字符串”部分【即不包括哈希和文件扩展名】，给定一个artifact ID，如“myartifact/1.0.1_26ab72615c65d7e857f.7z”，返回“1.0.1”）</li></ul><ul id="3a6a9200-6c97-45ce-8adb-a3e6ecbc34af" class="bulleted-list"><li>public StevedoreArtifact(RepoName repoName, ArtifactId id)(使用指定的reponame和artifact ID 创建一个 StevedoreArtifact。清单文件（如果使用）可能会覆盖存储库和工件版本)</li></ul><ul id="b941d8e2-9d66-495d-b60e-a37b728d071a" class="bulleted-list"><li>public StevedoreArtifact(ArtifactName name)(通过在清单文件中查找给定名称来创建 StevedoreArtifact)</li></ul><ul id="2bac2ba6-f699-42e5-820c-1ddc3d682345" class="bulleted-list"><li>public (NPath resolvedTargetDir, NPath resolvedArtifactVersionFile) EnsureSetupUnpack()(确保此 StevedoreArtifact 已在当前后端解包。 此方法在测试中很有用，正常使用时不需要)</li></ul><ul id="00f1056b-35d0-4bef-a630-a527a2507a44" class="bulleted-list"><li>public NPath UnpackToUnusualLocation(注册artifact（使用 Backend.Current）以直接解压到“build”或“artifacts”文件夹中的自定义位置。返回其他构建操作可以作为输入引用的版本文件的路径，而不是单个工件文件)</li></ul><ul id="116d3b1c-3092-479c-a71a-20192f15763e" class="bulleted-list"><li>public NPath[] GetFileList()<p id="01b61bf4-e480-4e68-9835-36904385be42" class="">检索此artifact中所有文件的列表。请注意此核心 Stevedore 系统扩展的一些问题：</p><p id="9805a7b3-1833-4171-9ce0-43ce2f6512ef" class="">(1). 如果文件列表尚未缓存，它将在前端下载，这在单个线程上同步发生（就像前端中的所有内容一样）。因此，在较差的网络条件下（最坏情况下每个文件列表 10 秒），使用大量文件列表会对性能产生重大影响。</p><p id="784dd54f-c016-4e94-9c9c-ec17c9326927" class="">(2). 这些前端下载在某些 .NET 运行时和操作系统组合上可能会遇到 SSL 证书问题（后端中的常规下载不会出现这些问题）。</p><p id="6ba93c72-b30c-4598-9cad-9e7b3c44c077" class="">(3). 前端的错误处理不够完善，并且没有遥测数据，这可能会使故障排除更加困难。</p><p id="8f368dd1-014e-44ec-8221-f8f41bd40775" class="">(4). &#x27;.filelist&#x27; artifacts没有校验和，因此会增加磁盘或传输中文件损坏的风险。</p><p id="ffaf74b4-3442-4c92-bb60-6a995fbdce14" class="">返回artifact中所有文件路径的列表。路径包括完整的基本路径，因此您可以直接使用它们。</p><p id="40554d23-96af-46db-9d45-2cea4b585bde" class="">
</p></li></ul></li></ol><p id="116c6364-cd60-45cf-a18e-a7c67e42c549" class="">  4. class StevedoreSettings<div class="indented"><p id="f7a7a315-84df-4f70-a9ff-db92f55d0f5d" class="">影响为特定后端(Backend.Current 当前TundraBackend的Steve.Settings)创建 StevedoreArtifacts 的设置。 可以将新的设置实例分配给 Backend.Current.Steve.Settings。</p><ul id="21fe82a0-23ef-4ec5-a7e2-5a22b710b5fc" class="bulleted-list"><li>static string MakeDefaultSteveInvocation(NPath relativeTo)（通过环境变量BEE_DOTNET_MUXER和BEE_DOTNET_NET5WRAPPER，知道bee 独立驱动程序正在 .net5 运行时上运行，且可以知道是哪一个。 让我们通过 dotnet 运行时和我们的 net5 wrapper运行所有steve调用）</li></ul><ul id="9da129a2-24af-44e6-a6e7-8a2defbce347" class="bulleted-list"><li>public bool EnforceManifest（是否拒绝下载清单中未列出的工件）</li></ul><ul id="98261677-6fab-4d2a-a53e-e8ad0261f528" class="bulleted-list"><li>public StevedoreSettings()（Steve调用）</li></ul></div></p><p id="e57a84f1-1fe4-45f8-b581-889702b5193f" class="">附录：</p><p id="67c860e5-3a94-4c61-82d9-cfe0a8289a59" class="">可以在这里浏览现有工件，具体浏览位置取决于他们所属的存储库</p><ul id="e0cdb9b6-881c-4e75-ad2c-9bc0bfd655cf" class="bulleted-list"><li>public (<a href="https://stevedore.unity3d.com/list/">https://stevedore.unity3d.com/list/</a>)</li></ul><ul id="475547c3-1df0-401f-82a8-3b05ad972869" class="bulleted-list"><li>unity-internal(<a href="https://artifactory.prd.it.unity3d.com/ui/repos/tree/General/stevedore-unity-internal">https://artifactory.prd.it.unity3d.com/ui/repos/tree/General/stevedore-unity-internal</a>)</li></ul><ul id="95948ef6-347b-46fd-923c-c7391491bef5" class="bulleted-list"><li>testing (<a href="https://artifactory.prd.it.unity3d.com/ui/repos/tree/General/stevedore-testing">https://artifactory.prd.it.unity3d.com/ui/repos/tree/General/stevedore-testing</a>)</li></ul><p id="01ce0b6b-483f-4bf3-a436-4440c5e608fc" class="">
</p><figure id="d5202f29-4c95-4ed2-bb6e-40f8a8b83790" class="image"><a href="index/WXWorkCapture_16300455065554.png"><img style="width:1783px" src="index/WXWorkCapture_16300455065554.png"/></a></figure><p id="923484e0-5c1d-4ab0-86cf-f8ee589ae2b1" class="">
</p><p id="b9d90068-345e-4a50-981f-b111b730eff6" class="">顾名思义，testing存储库仅用于测试；在生产环境中使用工件之前，必须将它们提升到生产存储库之一。要求#devs-stevedore promoted工件。</p><p id="16102033-1643-4fce-a2cc-da0042739e56" class="">所有员工都可以上传到testing，并且存储库（按照设计）充满了实验性和损坏的工件。作为一般规则，您可能应该避免使用其他人的testing工件 - 或者至少在使用之前询问。您可以看到谁在 Artifactory 上上传了给定的工件（上面的链接）</p><p id="d2ddce95-1ae1-4b2a-b985-8686ce0af2ff" class="">
</p><h3 id="39137f7a-29f7-4121-a7fa-19a5348e4b73" class="">2、Bee.Stevedore.Program</h3><p id="6df258c8-9ae0-4b6b-8f2a-886b34ccb0e2" class="">
</p><p id="6c06ee81-ec85-4152-9edd-8f06ddbb0bf9" class="">代码下文件列表如下：</p><figure id="45c5fc7e-406c-4aa1-8572-9c67c94a77fd" class="image"><a href="index/Untitled%2012.png"><img style="width:342px" src="index/Untitled%2012.png"/></a></figure><p id="7ef90c96-617b-4002-9fe4-ee87a9d9d178" class="">
</p><p id="8d35a6ea-b783-4c72-8b3e-cad9a21bb394" class="">
</p><p id="a405a828-bd9f-496b-a13e-ce51bd0071b2" class="">主要就是提供一些常用方法：</p><p id="1c7b72c9-db2e-4a4a-9fb2-6ae67ab1fc9a" class="">关于Artifact 校验规则，config对象的转换，下载缓存，下载器，http代理及错误提示， ssl错误提示，unpack命令，env设置 等，这边着重解释下一部分。</p><p id="0680c4f3-12e2-426a-bb34-88cda58a1802" class="">
</p><ul id="c31037ad-74a5-4230-8729-fb26d60e294e" class="bulleted-list"><li>ArtifactId.cs</li></ul><p id="455d43aa-75a8-4b5e-96c6-61ce01c8bc45" class="">
</p><pre id="2e7104d4-ae7b-4b5c-9507-97fd52878eb6" class="code"><code>     /// &lt;summary&gt;
    /// A valid and parsed Stevedore artifact ID.
    /// &lt;/summary&gt;
    public struct ArtifactId
    {
        internal const int MaxLength = ArtifactName.MaxLength + 1 + ArtifactVersion.MaxLength;

        public ArtifactName Name;
        public ArtifactVersion Version;

        public ArtifactId(string value)
        {
            var split = value.Split(new[] { &#x27;/&#x27; }, 3);
            if (split.Length != 2)
                throw new InvalidNameException(value, &quot;artifact ID&quot;, &quot;expected name and version, separated by &#x27;/&#x27;&quot;);

            Name = new ArtifactName(split[0]);
            Version = new ArtifactVersion(split[1]);
        }

        public override string ToString() =&gt; Name + &#x27;/&#x27; + Version;
    }</code></pre><p id="d796e579-c537-4022-b3d5-6af6d1798ca3" class="">
</p><p id="c5e2cda7-c416-472d-858f-a1adb9a5279e" class="">根据ArtifactName.MaxLength ，ArtifactVersion.MaxLength 我们搜索相关代码，得到以下的一些长度信息</p><p id="a070ada9-fb1c-40fe-a7fc-589c2bb03ce1" class="">
</p><pre id="58364f62-2425-486d-82d1-41e37ad51a6a" class="code"><code>MaxCacheFolderLengthWindows = 259 - &quot;/artifacts/&quot;.Length - ArtifactId.MaxLength;

ArtifactId.MaxLength= ArtifactName.MaxLength + 1 + ArtifactVersion.MaxLength

ArtifactName.MaxLength = 28
ArtifactVersion.MaxLength = VersionStringMaxLength + 1 + 64 + 7
VersionStringMaxLength = 40</code></pre><p id="35ee6b5d-a590-4a8b-955e-39fe36471141" class="">
</p></div></article></body></html>
